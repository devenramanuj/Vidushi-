<!DOCTYPE html>
<html lang="gu">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Gujarati Chatbot — Instant Reply (Single File)</title>
  <style>
    :root {
      --bg: #faf7f2;
      --card: #ffffff;
      --text: #1b1b1b;
      --accent: #0f766e;
      --accent-2: #075985;
      --muted: #6b7280;
      --bot: #fff5e6;
      --user: #e6fff2;
      --border: #e5e7eb;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      background: var(--bg);
      color: var(--text);
      font-family: "Noto Sans Gujarati", "Noto Sans", system-ui, -apple-system, Arial, sans-serif;
    }
    .app {
      max-width: 720px;
      margin: 0 auto;
      min-height: 100vh;
      display: grid;
      grid-template-rows: auto 1fr auto;
    }
    header {
      position: sticky; top: 0; z-index: 10;
      background: var(--card);
      border-bottom: 1px solid var(--border);
      padding: 12px 16px;
    }
    header .title { font-size: 18px; font-weight: 700; }
    header .subtitle { font-size: 13px; color: var(--muted); }
    .chat {
      padding: 12px;
      overflow-y: auto;
    }
    .msg {
      display: grid;
      grid-template-columns: 36px 1fr;
      gap: 8px;
      margin: 8px 0;
      align-items: start;
    }
    .avatar {
      width: 36px; height: 36px; border-radius: 50%;
      display: grid; place-items: center; font-weight: 700;
      color: #fff;
    }
    .avatar.bot { background: var(--accent); }
    .avatar.user { background: var(--accent-2); }
    .bubble {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 10px 12px;
      line-height: 1.5;
    }
    .bubble.bot { background: var(--bot); }
    .bubble.user { background: var(--user); }
    .time {
      font-size: 11px; color: var(--muted); margin-top: 6px;
    }
    .input {
      position: sticky; bottom: 0; z-index: 10;
      background: var(--card); border-top: 1px solid var(--border);
      padding: 10px;
    }
    .row {
      display: grid; grid-template-columns: 1fr auto; gap: 8px;
    }
    textarea {
      width: 100%; resize: none; min-height: 44px; max-height: 120px;
      padding: 10px 12px; border: 1px solid var(--border); border-radius: 10px;
      outline: none; font-size: 15px; line-height: 1.4; background: #fff;
    }
    button {
      padding: 0 16px; border: none; border-radius: 10px; height: 44px;
      background: var(--accent); color: #fff; font-weight: 700; cursor: pointer;
    }
    button:disabled { opacity: 0.6; cursor: not-allowed; }
    .actions { display: flex; gap: 8px; margin-top: 8px; }
    .secondary {
      background: #f3f4f6; color: #111827; border: 1px solid var(--border);
      font-weight: 600;
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div class="title">ગુજરાતી ચેટબોટ</div>
      <div class="subtitle">Instant reply • Single-file • No artificial delay</div>
    </header>

    <main id="chat" class="chat" aria-live="polite"></main>

    <section class="input">
      <div class="row">
        <textarea id="msg" placeholder="તમારો પ્રશ્ન લખો…" autocomplete="off"></textarea>
        <button id="send">મોકલો</button>
      </div>
      <div class="actions">
        <button class="secondary" id="clear">સાફ કરો</button>
        <button class="secondary" id="export">Export JSON</button>
      </div>
    </section>
  </div>

  <script>
    // ——— Instant engine: no delays, no unnecessary await ———

    // Basic local Q&A (you can extend; remains instant)
    const QA = [
      { q: "રામાયણ", a: "રામાયણમાં મુખ્યત્વે શ્રીરામનું જીવન, અયોધ્યા, વનવાસ, સીતાહરણ અને રાવણ વિધ્વંસ વર્ણવાય છે." },
      { q: "મહાભારત", a: "મહાભારતમાં કુરુક્ષેત્ર યુદ્ધ, પાંડવ-કૌરવ વિવાદ, ધર્મ-અધર્મનો સંઘર્ષ અને ભાગવદ ગીતા સમાવેશ થાય છે." },
      { q: "ગીતા", a: "ભગવદ ગીતા અર્જુનને શ્રીકૃષ્ણ દ્વારા સંભળાવેલ ધર્મ-કર્મ-યોગનો સાર છે." },
      { q: "ધર્મ", a: "ધર્મ એટલે કર્તવ્યભાવથી યોગ્ય કર્મ કરવો, અંતરમાં સત્ય-અહિંસાનું પાલન રાખવું." },
      { q: "યોગ", a: "યોગ અર્થાત્ મન-બુદ્ધિ-ઇન્દ્રિયોને સંયમમાં રાખી આત્મસાધના કરવી." }
    ];

    // Normalize for quick compare
    const normalize = (s) => s
      .toLowerCase()
      .replace(/[^\p{L}\p{N}\s]/gu, " ")
      .replace(/\s+/g, " ")
      .trim();

    // Lightweight fuzzy score (no loops beyond O(n), instant for small lists)
    function score(a, b) {
      // token overlap
      const ta = new Set(normalize(a).split(" "));
      const tb = new Set(normalize(b).split(" "));
      let match = 0;
      ta.forEach(t => { if (tb.has(t)) match++; });
      const denom = Math.max(ta.size, tb.size) || 1;
      return match / denom;
    }

    function findAnswer(userText) {
      const qn = normalize(userText);
      if (!qn) return "";
      // 1) exact starts-with / contains
      let best = { idx: -1, val: "", sc: 0 };
      for (let i = 0; i < QA.length; i++) {
        const cand = QA[i];
        const cq = normalize(cand.q);
        if (qn.startsWith(cq) || cq.startsWith(qn) || qn.includes(cq) || cq.includes(qn)) {
          return cand.a; // instant direct hit
        }
        const s = score(qn, cq);
        if (s > best.sc) best = { idx: i, val: cand.a, sc: s };
      }
      // 2) threshold for fuzzy
      if (best.sc >= 0.34) return best.val;
      // 3) default concise response
      return "મને ખ્યાલ આવ્યો કે તમે આધ્યાત્મિક વિષય પૂછો છો. કૃપા કરીને પ્રશ્ન થોડો સ્પષ્ટ લખશો—હું તરત જવાબ આપીશ.";
    }

    // Storage (optional, but fast) — no awaits
    const KEY = "gujarati-chatbot-log";
    function loadLog() {
      try { return JSON.parse(localStorage.getItem(KEY) || "[]"); } catch { return []; }
    }
    function saveLog(log) {
      try { localStorage.setItem(KEY, JSON.stringify(log)); } catch {}
    }

    const chatEl = document.getElementById("chat");
    const msgEl = document.getElementById("msg");
    const sendBtn = document.getElementById("send");
    const clearBtn = document.getElementById("clear");
    const exportBtn = document.getElementById("export");

    let log = loadLog();

    function fmtTime(d = new Date()) {
      const hh = d.getHours().toString().padStart(2, "0");
      const mm = d.getMinutes().toString().padStart(2, "0");
      return `${hh}:${mm}`;
    }

    function addMessage(role, text, time = fmtTime()) {
      const wrap = document.createElement("div");
      wrap.className = "msg";
      const avatar = document.createElement("div");
      avatar.className = `avatar ${role}`;
      avatar.textContent = role === "bot" ? "B" : "U";
      const bubble = document.createElement("div");
      bubble.className = `bubble ${role}`;
      bubble.textContent = text;
      const timeEl = document.createElement("div");
      timeEl.className = "time";
      timeEl.textContent = time;
      bubble.appendChild(timeEl);
      wrap.appendChild(avatar);
      wrap.appendChild(bubble);
      chatEl.appendChild(wrap);
      chatEl.scrollTop = chatEl.scrollHeight;
      log.push({ role, text, time });
      saveLog(log);
    }

    function instantReply(userText) {
      // Core: compute and render immediately
      const ans = findAnswer(userText);
      addMessage("bot", ans);
    }

    function handleSend() {
      const text = msgEl.value.trim();
      if (!text) return;
      addMessage("user", text);
      msgEl.value = "";
      // No artificial delay:
      instantReply(text);
    }

    function renderFromLog() {
      chatEl.innerHTML = "";
      for (const item of log) addMessage(item.role, item.text, item.time);
    }

    // Init
    renderFromLog();
    if (log.length === 0) {
      addMessage("bot", "નમસ્તે! હું ગુજરાતી ચેટબોટ છું. જે વિષય પૂછશો, હું તરત જવાબ આપીશ.");
    }

    // Events
    sendBtn.addEventListener("click", handleSend);
    msgEl.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        handleSend();
      }
    });
    clearBtn.addEventListener("click", () => {
      log = [];
      saveLog(log);
      renderFromLog();
      addMessage("bot", "ચેટ સાફ કરી. ફરીથી પ્રશ્ન પૂછો—જવાબ તરત મળશે.");
    });
    exportBtn.addEventListener("click", () => {
      const(log, null, 2);
      const blob = new Blob([data], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `chat-export-${Date.now()}.json`;
      document.body.appendChild(a);
      a.click();
      URL.revokeObjectURL(url);
      a.remove();
    });
  </script>
</body>
</html>
