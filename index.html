<!DOCTYPE html>
<html lang="gu">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>àªµàª¿àª¦à«àª·à«€ - AI Assistant</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root{
            --primary:#000000; --secondary:#1a1a1a; --light:#f0f0f0; --dark:#000000;
        }
        *{box-sizing:border-box;margin:0;padding:0;font-family:Inter,system-ui,-apple-system,'Segoe UI',sans-serif}
        body{
            background:var(--dark); color:var(--light); min-height:100vh; display:flex;align-items:center;justify-content:center;
            padding:20px;
        }
        .page{width:100%;max-width:460px}
        .ai-container{text-align:center}
        .ai-title{font-size:2.2rem;font-weight:800;margin-bottom:28px}
        .voice-interface{display:flex;flex-direction:column;align-items:center;gap:16px}
        .voice-circle{width:96px;height:96px;border-radius:50%;background:var(--secondary);border:2px solid var(--light);
            display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all .2s}
        .voice-circle:hover{transform:scale(1.02)}
        .voice-circle.listening{animation:pulse 1.6s infinite; background:var(--light)}
        @keyframes pulse{0%{box-shadow:0 0 0 0 rgba(255,255,255,.08)}50%{box-shadow:0 0 0 18px rgba(255,255,255,0)}100%{box-shadow:0 0 0 0 rgba(255,255,255,0)}}
        .mic-icon{font-size:36px;color:var(--light);transition:all .15s}
        .voice-circle.listening .mic-icon{color:var(--primary)}
        .voice-status{font-size:1rem;opacity:.95;min-height:22px}
        .nav-btn{position:fixed;top:14px;right:14px;width:44px;height:44px;border-radius:8px;background:var(--secondary);border:1px solid var(--light);
            display:flex;align-items:center;justify-content:center;color:var(--light);cursor:pointer}
        .back-btn{right:64px}
        .settings-container{background:var(--secondary);border:1px solid var(--light);padding:18px;border-radius:10px}
        .settings-title{font-size:1.4rem;margin-bottom:6px}
        .setting-group{margin-bottom:14px}
        input[type=password],select,input[type=range]{width:100%;padding:10px;border-radius:6px;border:1px solid #333;background:var(--primary);color:var(--light)}
        .model-selector{display:grid;grid-template-columns:repeat(2,1fr);gap:8px}
        .model-card{padding:10px;border-radius:6px;border:1px solid var(--light);background:transparent;cursor:pointer;text-align:center}
        .model-card.active{background:var(--light);color:var(--primary)}
        .btn{padding:10px 12px;border-radius:6px;border:none;background:var(--light);color:var(--primary);font-weight:700;cursor:pointer}
        .btn.secondary{background:transparent;border:1px solid var(--light);color:var(--light)}
        .status-message{display:none;padding:10px;border-radius:6px;margin-bottom:10px}
        .status-success{background:#122b11;color:#7ef0a1;border:1px solid #0f6b3f}
        .status-error{background:#2b0f0f;color:#f08b8b;border:1px solid #7a1515}
        .info-box{font-size:.9rem;padding:10px;border:1px solid #333;border-radius:6px;margin-top:6px}
        @media (max-width:420px){.ai-title{font-size:1.6rem}.voice-circle{width:80px;height:80px}.mic-icon{font-size:28px}}
    </style>
</head>
<body>
    <button class="nav-btn" id="settingsBtn" title="Settings"><i class="fas fa-cog"></i></button>
    <button class="nav-btn back-btn" id="backBtn" title="Back" style="display:none"><i class="fas fa-arrow-left"></i></button>

    <!-- Home -->
    <div id="homePage" class="page">
        <div class="ai-container">
            <h1 class="ai-title">àªµàª¿àª¦à«àª·à«€</h1>
            <div class="voice-interface">
                <div class="voice-circle" id="voiceBtn" title="àªŸà«…àªª àª•àª°à«‹ àª…àª¨à«‡ àªµàª¾àª¤ àª¶àª°à«‚ àª•àª°à«‹">
                    <i class="fas fa-microphone mic-icon"></i>
                </div>
                <div class="voice-status" id="voiceStatus">àªµàª¿àª¦à«àª·à«€ àª¸àª¾àª¥à«‡ àªµàª¾àª¤ àª•àª°àªµàª¾ àª®àª¾àªŸà«‡ àªŸà«‡àªª àª•àª°à«‹</div>
            </div>
        </div>
    </div>

    <!-- Settings -->
    <div id="settingsPage" class="page" style="display:none">
        <div class="settings-container">
            <div style="text-align:center;margin-bottom:10px">
                <div class="settings-title">àª¸à«‡àªŸàª¿àª‚àª—à«àª¸</div>
                <div style="opacity:.7;font-size:.9rem">àª¤àª®àª¾àª°àª¾ AI àª¸àª¹àª¾àª¯àª•àª¨à«‡ àª—à«‹àª àªµà«‹</div>
            </div>

            <div id="statusMessage" class="status-message"></div>

            <div class="setting-group">
                <label for="apiKey"><i class="fas fa-key"></i> Gemini API àª•à«€</label>
                <div style="position:relative">
                    <input id="apiKey" type="password" placeholder="àª¤àª®àª¾àª°à«€ Gemini API àª•à«€ àª¦àª¾àª–àª² àª•àª°à«‹">
                    <button id="toggleApiKey" style="position:absolute;right:8px;top:8px;background:none;border:none;color:var(--light);cursor:pointer"><i class="fas fa-eye"></i></button>
                </div>
                <div style="margin-top:8px">
                    <button id="saveApiKey" class="btn" style="width:100%"><i class="fas fa-save"></i> API àª•à«€ àª¸à«‡àªµ àª•àª°à«‹</button>
                </div>
            </div>

            <div class="setting-group">
                <label><i class="fas fa-brain"></i> AI àª®à«‹àª¡à«‡àª²</label>
                <div class="model-selector">
                    <div class="model-card active" data-model="gemini-2.5-flash"><div>Flash (àªàª¡àªªà«€)</div></div>
                    <div class="model-card" data-model="gemini-1.5-pro"><div>Pro (àª—à«àª£àªµàª¤à«àª¤àª¾)</div></div>
                </div>
                <div class="info-box">àªàª¡àªªà«€ àªœàªµàª¾àª¬ àª®àª¾àªŸà«‡ 'Flash' àªªàª¸àª‚àª¦ àª•àª°à«‹.</div>
            </div>

            <div class="setting-group">
                <label for="language"><i class="fas fa-language"></i> àª­àª¾àª·àª¾</label>
                <select id="language">
                    <option value="gu-IN">Gujarati (àª—à«àªœàª°àª¾àª¤à«€)</option>
                    <option value="hi-IN">Hindi (à¤¹à¤¿à¤‚à¤¦à¥€)</option>
                    <option value="en-US">English</option>
                </select>
            </div>

            <div class="setting-group">
                <label for="voice"><i class="fas fa-microphone"></i> àª…àªµàª¾àªœ àªªà«àª°àª•àª¾àª°</label>
                <select id="voice">
                    <option value="female">àª¸à«àª¤à«àª°à«€ àª…àªµàª¾àªœ</option>
                    <option value="male">àªªà«àª°à«àª· àª…àªµàª¾àªœ</option>
                </select>
            </div>

            <div class="setting-group">
                <label for="speechRate"><i class="fas fa-tachometer-alt"></i> àª¬à«‹àª²àªµàª¾àª¨à«€ àª—àª¤àª¿</label>
                <input id="speechRate" type="range" min="0.7" max="1.5" step="0.1" value="1">
                <div style="text-align:center;margin-top:6px;opacity:.8"><span id="rateValue">1.0x</span></div>
            </div>

            <div style="display:flex;gap:8px;margin-top:12px">
                <button id="saveSettings" class="btn" style="flex:1"><i class="fas fa-save"></i> àª¸à«‡àªµ àª•àª°à«‹</button>
                <button id="resetSettings" class="btn secondary" style="flex:1"><i class="fas fa-undo"></i> àª°à«€àª¸à«‡àªŸ</button>
            </div>

            <div style="margin-top:12px;display:flex;gap:8px;flex-direction:column">
                <button id="testVoiceBtn" class="btn secondary"><i class="fas fa-play"></i> àª…àªµàª¾àªœ àªšàª•àª¾àª¸à«‹</button>
                <button id="testApiBtn" class="btn secondary"><i class="fas fa-bolt"></i> API àªšàª•àª¾àª¸à«‹</button>
            </div>

            <div class="info-box" style="margin-top:12px">
                <strong>àª®àª«àª¤ API àª•à«€ àª®à«‡àª³àªµà«‹:</strong><br>
                1. Google AI Studio àªªàª° àªœàª¾àª“.<br>
                2. "Create API Key" àªªàª° àª•à«àª²àª¿àª• àª•àª°à«‹.<br>
                3. àª•à«€ àª•à«‹àªªà«€ àª•àª°à«‹ (AIza... àª¥à«€ àª¶àª°à«‚ àª¥àª¾àª¯ àª›à«‡).
            </div>
        </div>
    </div>

<script>
class VidushiAI {
    constructor(){
        // config & cache
        this.systemPrompt = "àª¤àª®àª¾àª°à«àª‚ àª¨àª¾àª® àªµàª¿àª¦à«àª·à«€ àª›à«‡. àª¸àª‚àª•à«àª·àª¿àªªà«àª¤ àª…àª¨à«‡ àª¸à«àªªàª·à«àªŸ àª°à«€àª¤à«‡ àªœàªµàª¾àª¬ àª†àªªà«‹. àª®àª¾àª¤à«àª° àª—à«àªœàª°àª¾àª¤à«€àª®àª¾àª‚ àªœàªµàª¾àª¬ àª†àªªà«‹.";
        this.apiRequestTimeoutMs = 8000;
        this.responseCache = new Map(); // in-memory
        // elements
        this.homePage = document.getElementById('homePage');
        this.settingsPage = document.getElementById('settingsPage');
        this.settingsBtn = document.getElementById('settingsBtn');
        this.backBtn = document.getElementById('backBtn');
        this.voiceBtn = document.getElementById('voiceBtn');
        this.voiceStatus = document.getElementById('voiceStatus');
        this.apiKeyInput = document.getElementById('apiKey');
        this.toggleApiKeyBtn = document.getElementById('toggleApiKey');
        this.saveApiKeyBtn = document.getElementById('saveApiKey');
        this.modelCards = document.querySelectorAll('.model-card');
        this.languageSelect = document.getElementById('language');
        this.voiceSelect = document.getElementById('voice');
        this.speechRate = document.getElementById('speechRate');
        this.rateValue = document.getElementById('rateValue');
        this.saveSettingsBtn = document.getElementById('saveSettings');
        this.resetSettingsBtn = document.getElementById('resetSettings');
        this.testVoiceBtn = document.getElementById('testVoiceBtn');
        this.testApiBtn = document.getElementById('testApiBtn');
        this.statusMessage = document.getElementById('statusMessage');

        // runtime state
        this.recognition = null;
        this.speechSynthesis = window.speechSynthesis;
        this.availableVoices = [];
        this.isListening = false;
        this.isProcessing = false;
        this.initialGreetingDone = false;

        // defaults/load
        this.loadSettings();
        this.loadSpeechVoices(); // preload voices
        this.setupEventListeners();

        // greeting
        setTimeout(()=>this.initialGreeting(),500);
    }

    // UI navigation
    showHome(){ this.homePage.style.display='block'; this.settingsPage.style.display='none'; this.settingsBtn.style.display='flex'; this.backBtn.style.display='none'; }
    showSettings(){ this.homePage.style.display='none'; this.settingsPage.style.display='block'; this.settingsBtn.style.display='none'; this.backBtn.style.display='flex'; }

    // load settings from localStorage
    loadSettings(){
        this.apiKey = localStorage.getItem('geminiApiKey') || null;
        const s = localStorage.getItem('geminiSettings');
        if (s){
            try {
                const st = JSON.parse(s);
                this.language = st.language || 'gu-IN';
                this.voiceType = st.voice || 'female';
                this.speechRateValue = st.speechRate || 1;
                this.currentModel = st.model || 'gemini-2.5-flash';
                // apply to UI
                if(this.languageSelect) this.languageSelect.value = this.language;
                if(this.voiceSelect) this.voiceSelect.value = this.voiceType;
                if(this.speechRate){ this.speechRate.value = this.speechRateValue; this.rateValue.textContent = this.speechRateValue + 'x'; }
                if(this.modelCards) this.modelCards.forEach(c=>c.classList.toggle('active', c.dataset.model===this.currentModel));
            } catch(e){}
        } else {
            this.language = 'gu-IN';
            this.voiceType = 'female';
            this.speechRateValue = 1;
            this.currentModel = 'gemini-2.5-flash';
        }
        if (this.apiKey && this.apiKeyInput) this.apiKeyInput.value = 'â€¢'.repeat(32);
    }

    // persist settings
    saveAllSettings(){
        const s = {
            language: this.languageSelect.value,
            voice: this.voiceSelect.value,
            speechRate: this.speechRate.value,
            model: this.currentModel || 'gemini-2.5-flash'
        };
        localStorage.setItem('geminiSettings', JSON.stringify(s));
        this.showStatus('àª¬àª§à«€ àª¸à«‡àªŸàª¿àª‚àª—à«àª¸ àª¸à«‡àªµ àª¥àª‡ àª—àªˆ', 'success');
    }

    resetSettings(){
        localStorage.removeItem('geminiSettings');
        this.loadSettings();
        this.showStatus('àª¸à«‡àªŸàª¿àª‚àª—à«àª¸ àª°àª¿àª¸à«‡àªŸ àª¥àª¯àª¾àª‚', 'success');
    }

    // pre-load voices to reduce first-speak delay
    loadSpeechVoices(){
        const tryLoad = ()=> {
            this.availableVoices = this.speechSynthesis.getVoices() || [];
            // no-op; just ensure voices are populated
        };
        tryLoad();
        this.speechSynthesis.addEventListener && this.speechSynthesis.addEventListener('voiceschanged', tryLoad);
    }

    // event listeners
    setupEventListeners(){
        this.settingsBtn && this.settingsBtn.addEventListener('click', ()=>this.showSettings());
        this.backBtn && this.backBtn.addEventListener('click', ()=>this.showHome());
        this.toggleApiKeyBtn && this.toggleApiKeyBtn.addEventListener('click', ()=>{
            if (!this.apiKeyInput) return;
            const t = this.apiKeyInput.type === 'password' ? 'text' : 'password';
            this.apiKeyInput.type = t;
            this.toggleApiKeyBtn.innerHTML = t==='password' ? '<i class="fas fa-eye"></i>' : '<i class="fas fa-eye-slash"></i>';
        });
        this.saveApiKeyBtn && this.saveApiKeyBtn.addEventListener('click', ()=>this.saveApiKey());
        this.modelCards && this.modelCards.forEach(card => {
            card.addEventListener('click', ()=>{
                this.modelCards.forEach(c=>c.classList.remove('active'));
                card.classList.add('active');
                this.currentModel = card.dataset.model;
            });
        });
        this.voiceBtn && this.voiceBtn.addEventListener('click', ()=>this.onVoiceBtnClick());
        this.speechRate && this.speechRate.addEventListener('input', ()=>{ this.rateValue.textContent = this.speechRate.value + 'x'; });
        this.saveSettingsBtn && this.saveSettingsBtn.addEventListener('click', ()=>this.saveAllSettings());
        this.resetSettingsBtn && this.resetSettingsBtn.addEventListener('click', ()=>this.resetSettings());
        this.testVoiceBtn && this.testVoiceBtn.addEventListener('click', ()=>this.testVoice());
        this.testApiBtn && this.testApiBtn.addEventListener('click', ()=>this.testApiConnection());

        // setup Web Speech Recognition if available
        if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window){
            try {
                this.recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
                this.recognition.continuous = false;
                this.recognition.interimResults = false;
                this.recognition.lang = this.language || 'gu-IN';
                this.recognition.onstart = ()=>{ this.isListening=true; this.voiceBtn.classList.add('listening'); this.voiceStatus.textContent='ğŸ¤ àª¸àª¾àª‚àª­àª³à«€ àª°àª¹à«€ àª›à«àª‚...'; };
                this.recognition.onresult = (e)=> {
                    const t = e.results[0][0].transcript;
                    this.processUserInput(t);
                };
                this.recognition.onerror = (e)=>{ console.error('rec error', e); this.showNotification('Speech recognition error', 'error'); this.stopRecognition(); };
                this.recognition.onend = ()=>{ this.stopRecognition(); };
            } catch(e){
                console.warn('speech recognition not available', e);
            }
        } else {
            // disable mic visually if not supported
            this.voiceBtn && (this.voiceBtn.style.opacity = .5);
        }
    }

    showNotification(message, type='info'){
        // small toast (non-blocking)
        const n = document.createElement('div');
        n.textContent = message;
        n.style.cssText = `position:fixed;top:14px;left:14px;padding:8px 12px;border-radius:6px;background:${type==='error'?'#e34c4c':'#fff'};color:${type==='error'?'#fff':'#000'};z-index:9999;box-shadow:0 6px 18px rgba(0,0,0,.25)`;
        document.body.appendChild(n);
        setTimeout(()=>{ n.style.opacity='0'; setTimeout(()=>n.remove(),350); },3500);
    }

    showStatus(message, kind){
        if (!this.statusMessage) return;
        this.statusMessage.textContent = message;
        this.statusMessage.className = 'status-message ' + (kind==='success' ? 'status-success' : 'status-error');
        this.statusMessage.style.display = 'block';
        setTimeout(()=>{ this.statusMessage.style.display = 'none'; },3500);
    }

    saveApiKey(){
        const k = this.apiKeyInput && this.apiKeyInput.value.trim();
        if (!k){ this.showStatus('àª•à«ƒàªªàª¾ àª•àª°à«€àª¨à«‡ API àª•à«€ àª¦àª¾àª–àª² àª•àª°à«‹', 'error'); return; }
        // allow saved masked value
        if (k === 'â€¢'.repeat(32) && localStorage.getItem('geminiApiKey')) { this.showStatus('API àª•à«€ àªªàª¹à«‡àª²à«‡àª¥à«€ àª¸à«‡àªµ àª›à«‡', 'error'); return; }
        // quick validation (must start with AIz)
        if (!k.startsWith('AIza')) { this.showStatus('àª…àª¯à«‹àª—à«àª¯ API àª•à«€ àª«à«‹àª°à«àª®à«‡àªŸ', 'error'); return; }
        this.apiKey = k;
        localStorage.setItem('geminiApiKey', k);
        this.apiKeyInput.type = 'password';
        this.apiKeyInput.value = 'â€¢'.repeat(32);
        this.showStatus('API àª•à«€ àª¸àª«àª³àª¤àª¾àªªà«‚àª°à«àªµàª• àª¸à«‡àªµ àª¥àªˆ', 'success');
    }

    onVoiceBtnClick(){
        if (!this.recognition){ this.showNotification('Speech recognition not supported in this browser', 'error'); return; }
        if (!localStorage.getItem('geminiApiKey')){ this.showNotification('àª•à«ƒàªªàª¾ àª•àª°à«€àª¨à«‡ àªªàª¹à«‡àª²àª¾ API àª•à«€ àª¸à«‡àªµ àª•àª°à«‹', 'error'); return; }
        if (this.isListening){ try{ this.recognition.stop(); }catch(e){}; return; }
        // optimistic UI
        this.voiceStatus.textContent = 'ğŸ”„ àªŸà«‡àª²àª¿àª«à«‹àª¨ àª•àª°à«€àª¨à«‡ àªµàª¿àªšàª¾àª° àª•àª°à«€ àª°àª¹à«€ àª›à«àª‚...';
        try {
            this.recognition.lang = this.languageSelect.value || 'gu-IN';
            this.recognition.start();
        } catch(e){
            console.error('start err', e);
            this.showNotification('Speech start error', 'error');
        }
    }

    stopRecognition(){
        this.isListening = false;
        this.voiceBtn.classList.remove('listening');
        if (!this.isProcessing) this.voiceStatus.textContent = 'àªµàª¿à¦¦à«àª·à«€ àª¸àª¾àª¥à«‡ àªµàª¾àª¤ àª•àª°àªµàª¾ àª®àª¾àªŸà«‡ àªŸà«‡àªª àª•àª°à«‹';
    }

    // process recognized/user text
    async processUserInput(text){
        if (!text || !text.trim()) return;
        if (this.isProcessing) return;
        // stop command
        if (text.toLowerCase().includes('àª¬àª‚àª§')) {
            if (this.speechSynthesis.speaking) this.speechSynthesis.cancel();
            this.voiceStatus.textContent = 'ğŸ”‡ àª¬à«‹àª²àªµàª¾àª¨à«àª‚ àª¬àª‚àª§ àª•àª°à«àª¯à«àª‚';
            setTimeout(()=> this.voiceStatus.textContent = 'àªµàª¿àª¦à«àª·à«€ àª¸àª¾àª¥à«‡ àªµàª¾àª¤ àª•àª°àªµàª¾ àª®àª¾àªŸà«‡ àªŸà«‡àªª àª•àª°à«‹', 2500);
            return;
        }

        this.isProcessing = true;
        this.voiceStatus.textContent = 'ğŸ’­ àªµàª¿àªšàª¾àª°à«€ àª°àª¹à«àª¯àª¾ àª›à«‡...';
        try {
            const resp = await this.callGeminiAPI(text);
            if (resp){
                this.voiceStatus.textContent = 'ğŸ—£ï¸ àªœàªµàª¾àª¬ àª®àª³à«€ àª—àª¯à«‹';
                // speak if enabled
                const autoSpeak = true; // kept default true in this simplified version
                if (autoSpeak) this.speakText(resp);
            } else {
                this.voiceStatus.textContent = 'âŒ àªœàªµàª¾àª¬ àª¨ àª®àª³à«àª¯à«‹';
                this.showNotification('àª®àª¾àª« àª•àª°àª¶à«‹, àªœàªµàª¾àª¬ àª‰àªªàª²àª¬à«àª§ àª¨àª¥à«€', 'error');
            }
        } catch(err){
            console.error('API Error', err);
            this.voiceStatus.textContent = 'âŒ API àª­à«‚àª²';
            this.showNotification('API àª­à«‚àª²: ' + (err.message || ''), 'error');
        } finally {
            this.isProcessing = false;
            setTimeout(()=>{ if (!this.isListening) this.voiceStatus.textContent = 'àªµàª¿à¤¦à«àª·à«€ àª¸àª¾àª¥à«‡ àªµàª¾àª¤ àª•àª°àªµàª¾ àª®àª¾àªŸà«‡ àªŸà«‡àªª àª•àª°à«‹'; }, 1200);
        }
    }

    // call Gemini API with timeout, small system prompt, cache
    async callGeminiAPI(userMessage){
        const apiKey = localStorage.getItem('geminiApiKey') || this.apiKey;
        if (!apiKey) throw new Error('API Key not set.');
        const modelName = this.currentModel || 'gemini-2.5-flash';
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${modelName}:generateContent?key=${apiKey}`;

        const cacheKey = `${modelName}::${userMessage.trim().slice(0,180)}`;
        if (this.responseCache.has(cacheKey)) return this.responseCache.get(cacheKey);

        const body = {
            contents: [
                { role: "system", parts: [{ text: this.systemPrompt }] },
                { role: "user", parts: [{ text: userMessage }] }
            ],
            generationConfig: {
                temperature: 0.1,
                maxOutputTokens: 80
            }
        };

        const controller = new AbortController();
        const timeout = setTimeout(()=>controller.abort(), this.apiRequestTimeoutMs);

        try {
            const res = await fetch(apiUrl, {
                method: 'POST',
                headers: {'Content-Type':'application/json'},
                body: JSON.stringify(body),
                signal: controller.signal
            });
            clearTimeout(timeout);
            if (!res.ok){
                let errText = `Status ${res.status}`;
                try { const j = await res.json(); errText = j.error?.message || errText; } catch(e){}
                throw new Error(errText);
            }
            const data = await res.json();
            const text = data?.candidates?.[0]?.content?.parts?.[0]?.text || '';
            if (text) {
                this.responseCache.set(cacheKey, text);
                // expire cache after 5 minutes
                setTimeout(()=>this.responseCache.delete(cacheKey), 5*60*1000);
            }
            return text;
        } catch(e){
            if (e.name === 'AbortError') throw new Error('API timeout');
            throw e;
        }
    }

    // sanitize and speak
    sanitizeTextForSpeech(t){
        return (t || '').replace(/[\[\]\(\)\{\}\<\>\/\\]+/g,' ').replace(/\s+/g,' ').trim();
    }

    speakText(text){
        if (!this.speechSynthesis) return;
        if (this.speechSynthesis.speaking) this.speechSynthesis.cancel();
        const cleaned = this.sanitizeTextForSpeech(text);
        if (!cleaned) return;
        const sentences = cleaned.split(/(?<=[.!?])\s+/).filter(s=>s.trim().length>0);
        const voices = this.speechSynthesis.getVoices() || [];
        let selected = voices.find(v=>v.lang===this.languageSelect.value && /female/i.test(v.name)) || voices.find(v=>v.lang===this.languageSelect.value) || voices[0];
        let idx = 0;
        const speakNext = ()=>{
            if (idx >= sentences.length) { this.voiceStatus.textContent='àªµàª¿àª¦à«àª·à«€ àª¸àª¾àª¥à«‡ àªµàª¾àª¤ àª•àª°àªµàª¾ àª®àª¾àªŸà«‡ àªŸà«‡àªª àª•àª°à«‹'; return; }
            const u = new SpeechSynthesisUtterance(sentences[idx]);
            u.lang = this.languageSelect.value || 'gu-IN';
            u.rate = parseFloat(this.speechRate.value) || 1;
            u.pitch = this.voiceSelect.value === 'female' ? 1.05 : 0.95;
            u.voice = selected || null;
            u.onstart = ()=>{ this.voiceStatus.textContent = 'ğŸ—£ï¸ àª¬à«‹àª²à«€ àª°àª¹à«€ àª›à«‡...'; this.voiceBtn.classList.remove('listening'); };
            u.onend = ()=>{ idx++; setTimeout(speakNext, 180); };
            this.speechSynthesis.speak(u);
        };
        speakNext();
    }

    testVoice(){ this.speakText("àªœàª¯ àª¶à«àª°à«€ àª•à«ƒàª·à«àª£. àª¹à«àª‚ àªµàª¿àª¦à«àª·à«€ àª›à«àª‚. àª¹à«àª‚ àª¤àª®àª¨à«‡ àª®àª¦àª¦ àª•àª°àªµàª¾ àª®àª¾àªŸà«‡ àª¹àª‚àª®à«‡àª¶àª¾ àª¤à«ˆàª¯àª¾àª° àª›à«àª‚."); }

    testApiConnection(){
        const apiKey = localStorage.getItem('geminiApiKey') || this.apiKey;
        if (!apiKey){ this.showNotification('àª•à«ƒàªªàª¾ àª•àª°à«€àª¨à«‡ API àª•à«€ àª¦àª¾àª–àª² àª•àª°à«‹', 'error'); return; }
        this.voiceStatus.textContent='ğŸ”„ API àªšà«‡àª• àª•àª°à«€ àª°àª¹à«€ àª›à«‡...';
        this.callGeminiAPI("àª¤àª¾àª°à«àª‚ àª¨àª¾àª® àª¶à«àª‚ àª›à«‡?")
            .then(r=>{ this.showNotification('API àªœà«‹àª¡àª¾àª£ àª¸àª«àª³', 'info'); if (r) this.speakText(r); this.voiceStatus.textContent='âœ… API àª¸àª«àª³'; })
            .catch(e=>{ this.showNotification('API àª«à«‡àª°: ' + (e.message||''), 'error'); this.voiceStatus.textContent='âŒ API àª¨àª¿àª·à«àª«àª³'; });
    }

    initialGreeting(){
        if (this.initialGreetingDone) return;
        const g = "àªœàª¯ àª¶à«àª°à«€ àª•à«ƒàª·à«àª£. àª¹à«àª‚ àªµàª¿àª¦à«àª·à«€ àª›à«àª‚. àª¤àª®à«‡ àª•à«‡àª® àª›à«‹?";
        this.speakText(g);
        this.initialGreetingDone = true;
    }
}

// init on DOM ready
document.addEventListener('DOMContentLoaded', ()=>{
    const app = new VidushiAI();
    window.vidushiAI = app;
});
</script>
</body>
</html>
