<!DOCTYPE html>
<html lang="gu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>àªµàª¿àª¦à«àª·à«€ AI Assistant</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            /* Theme Variables */
            --primary-bg: #121212;
            --secondary-bg: #1e1e1e;
            --chat-bg: #292929;
            --text-color: #ffffff;
            --accent-red: #8b0000;
            --border-color: #333333;
            --button-color: #444444;
            --status-green: #00ff00;
            --status-red: #ff0000;
            --status-blue: #00ffff;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        
        body {
            background: var(--primary-bg);
            min-height: 100vh;
            color: var(--text-color);
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            overflow: hidden; /* àª¸à«àª•à«àª°à«‹àª²àª¿àª‚àª— àª¬àª‚àª§ */
        }
        
        .container {
            width: 100%;
            max-width: 600px;
            background: var(--secondary-bg);
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.7);
            overflow: hidden;
            border: 1px solid var(--border-color);
            position: relative;
            display: flex;
            flex-direction: column;
            height: 95vh; 
        }
        
        /* HEADER */
        header {
            background: var(--secondary-bg);
            padding: 15px 20px;
            text-align: center;
            border-bottom: 1px solid var(--border-color);
            flex-shrink: 0;
            z-index: 10;
        }
        
        h1 { font-size: 2.2rem; font-weight: 500; color: var(--text-color); }
        .header-line { height: 2px; background-color: var(--accent-red); width: 100%; margin-top: 5px; }
        
        .content-area {
            flex-grow: 1;
            position: relative;
            overflow: hidden;
            display: flex;
        }

        #chatPage, #settingsPage {
            padding: 10px;
            display: flex;
            flex-direction: column;
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0; left: 0;
            background: var(--secondary-bg);
            transition: opacity 0.3s ease;
        }

        #settingsPage { display: none; z-index: 20; overflow-y: auto; padding: 20px; }
        
        .chat-container {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            height: 100%;
            overflow: hidden;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        /* Hiding the text messages list */
        .chat-messages {
            display: none !important; /* àª²àª–àª¾àª£ àª•àª¾àª¯àª® àª®àª¾àªŸà«‡ àª—àª¾àª¯àª¬ */
        }

        /* --- Avatar Setup --- */
        #main-avatar-container {
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 10px;
        }

        #avatar-image {
            max-width: 95%;
            max-height: 65vh; /* àª«à«‹àªŸà«‹ àª¥à«‹àª¡à«‹ àª®à«‹àªŸà«‹ àª•àª°à«àª¯à«‹ */
            border-radius: 15px;
            object-fit: cover; /* àª«à«‹àªŸà«‹ àª¸àª°àª¸ àª°à«€àª¤à«‡ àª«àª¿àªŸ àª¥àª¶à«‡ */
            transition: transform 0.2s ease-in-out;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
        }

        /* --- Lip Sync Animation --- */
        .speaking-animation {
            animation: talk-pulse 0.25s infinite alternate ease-in-out;
            filter: brightness(1.1); /* àª¬à«‹àª²àª¤à«€ àªµàª–àª¤à«‡ àªšàª¹à«‡àª°à«‹ àª¥à«‹àª¡à«‹ àªšàª®àª•àª¶à«‡ */
        }

        @keyframes talk-pulse {
            0% { transform: scale(1); }
            100% { transform: scale(1.04); } 
        }

        /* --- CONTROLS --- */
        .voice-controls {
            padding: 15px 0;
            border-top: 1px solid var(--border-color);
            display: flex;
            flex-direction: row; 
            justify-content: center;
            align-items: center;
            gap: 20px;
            flex-shrink: 0;
            z-index: 10;
            background: var(--secondary-bg);
        }
        
        .voice-btn {
            width: 70px; height: 70px; border-radius: 50%;
            background: var(--button-color); border: none; color: var(--text-color);
            font-size: 28px; cursor: pointer; transition: all 0.3s;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        .voice-btn:hover { background: #555; transform: scale(1.05); }
        .voice-btn.listening { background: var(--status-red); animation: pulse-ring 1.5s infinite; }
        .voice-btn.continuous-active::after {
            content: '\f021'; font-family: 'Font Awesome 6 Free'; font-weight: 900;
            position: absolute; top: -5px; right: -5px; background: var(--status-blue);
            color: black; font-size: 10px; width: 22px; height: 22px;
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            border: 2px solid var(--secondary-bg);
        }

        #stopBtn {
            width: 50px; height: 50px; border-radius: 50%;
            background: #ff0000; border: 2px solid #8b0000; color: white;
            font-size: 20px; display: flex; align-items: center; justify-content: center;
            cursor: pointer; transition: all 0.3s;
        }
        #stopBtn:hover { transform: scale(1.1); }
        
        @keyframes pulse-ring {
            0% { box-shadow: 0 0 0 0 rgba(255, 0, 0, 0.5); }
            70% { box-shadow: 0 0 0 15px rgba(255, 0, 0, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 0, 0, 0); }
        }

        .status-bar {
            position: absolute; top: 10px; left: 20px;
            display: flex; align-items: center; gap: 8px; z-index: 5;
            background: rgba(0,0,0,0.5); padding: 5px 10px; border-radius: 20px;
        }
        .status-dot { width: 10px; height: 10px; border-radius: 50%; background: var(--status-red); }
        .status-text { font-size: 12px; color: #ccc; }
        .screen-lock-status { font-size: 10px; color: #666; display: none; margin-left: 5px; }
        .screen-lock-status.active { display: inline; color: var(--status-green); }

        #toggleSettingsBtn {
            position: absolute; top: 20px; right: 20px; z-index: 30;
            background: var(--button-color); border: none; color: var(--text-color);
            width: 40px; height: 40px; border-radius: 50%; cursor: pointer; font-size: 18px;
        }

        /* Settings UI */
        .settings-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; padding-bottom: 15px; border-bottom: 1px solid var(--border-color); }
        .setting-group { margin-bottom: 20px; padding-bottom: 10px; border-bottom: 1px dashed #333; }
        .setting-group label { display: block; margin-bottom: 8px; font-size: 14px; color: #ccc; }
        .setting-group input, .setting-group select, .setting-group button { width: 100%; padding: 10px 12px; background: var(--chat-bg); border: 1px solid #444; border-radius: 6px; color: white; margin-top: 5px; }
        .model-selector button { width: auto; margin-right: 10px; margin-top: 5px; }
        .model-btn.active { background: #555; border-color: var(--text-color); }
        .toggle-switch { position: relative; display: inline-block; width: 50px; height: 24px; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #444; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--status-green); }
        input:checked + .slider:before { transform: translateX(26px); }

        .footer { text-align: center; padding: 10px; font-size: 12px; color: #666; border-top: 1px solid var(--border-color); background: var(--secondary-bg); flex-shrink: 0; }
    </style>
</head>
<body>
    <div class="container">
        <button id="toggleSettingsBtn" title="àª¸à«‡àªŸàª¿àª‚àª—à«àª¸"><i class="fas fa-cog"></i></button>

        <header>
            <h1>àªµàª¿àª¦à«àª·à«€</h1>
            <div class="header-line"></div>
        </header>
        
        <div class="content-area">
            
            <div id="chatPage">
                <div class="chat-container">
                    
                    <div class="status-bar">
                        <div class="status-dot" id="statusDot"></div>
                        <span id="connectionStatus" class="status-text">Key àªœàª°à«‚àª°à«€ àª›à«‡</span>
                        <i class="fas fa-sun screen-lock-status" id="screenLockIcon"></i>
                    </div>

                    <div id="main-avatar-container">
                        <img id="avatar-image" src="https://images.unsplash.com/photo-1621784563330-caee0b138a00?q=80&w=1000&auto=format&fit=crop&ixlib=rb-4.0.3" alt="Vidushi Avatar">
                    </div>

                    <div class="chat-messages" id="chatMessages"></div>

                </div>
                
                <div class="voice-controls">
                    <button class="voice-btn" id="voiceBtn" title="àª¬à«‹àª²àªµàª¾ àª®àª¾àªŸà«‡ àª•à«àª²àª¿àª• àª•àª°à«‹"><i class="fas fa-microphone"></i></button>
                    <button id="stopBtn" title="àªµàª¾àª¤àªšà«€àª¤ àª¬àª‚àª§ àª•àª°à«‹ (Mute)"><i class="fas fa-volume-xmark"></i></button>
                </div>
            </div>
            
            <div id="settingsPage">
                <div class="settings-header">
                    <h2>àª¸à«‡àªŸàª¿àª‚àª—à«àª¸</h2>
                    <button id="backToChatBtn"><i class="fas fa-arrow-left"></i> àªªàª¾àª›àª¾ àªœàª¾àª“</button>
                </div>

                <div class="setting-group">
                    <label>Gemini API Key</label>
                    <div style="display: flex; gap: 5px;">
                        <input type="password" id="apiKey" placeholder="Paste API Key Here">
                        <button type="button" id="toggleApiKey" style="width: 40px; padding: 0;"><i class="fas fa-eye"></i></button>
                    </div>
                    <button id="saveApiKey" style="margin-top: 10px;">Save Key</button>
                    <button id="testApiBtn" style="margin-top: 10px; background: #333;">Test API</button>
                </div>

                <div class="setting-group" style="border: 1px solid #555; padding: 15px; border-radius: 8px; background: #252525;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <label style="margin: 0; color: #fff;">àª¸àª¤àª¤ àªµàª¾àª¤àªšà«€àª¤ (Continuous)</label>
                        <label class="toggle-switch"><input type="checkbox" id="continuousMode"><span class="slider"></span></label>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center; border-top: 1px solid #444; padding-top: 10px;">
                        <label style="margin: 0; color: #ddd;">àª¸à«àª•à«àª°à«€àª¨ àªšàª¾àª²à« àª°àª¾àª–à«‹ (Wake Lock)</label>
                        <label class="toggle-switch"><input type="checkbox" id="screenWakeLock" checked><span class="slider"></span></label>
                    </div>
                </div>
                
                <div class="setting-group">
                    <label>AI Model</label>
                    <div class="model-selector">
                        <button class="model-btn active" data-model="gemini-2.5-flash">Flash</button>
                        <button class="model-btn" data-model="gemini-2.5-pro">Pro</button>
                    </div>
                </div>
                
                <div class="setting-group">
                    <label>àª­àª¾àª·àª¾</label>
                    <select id="language">
                        <option value="gu-IN">Gujarati</option>
                        <option value="en-US">English</option>
                        <option value="hi-IN">Hindi</option>
                    </select>
                </div>
                
                <div class="setting-group">
                    <label>àª…àªµàª¾àªœ</label>
                    <select id="voice">
                        <option value="female">àª¸à«àª¤à«àª°à«€ àª…àªµàª¾àªœ</option>
                        <option value="male">àªªà«àª°à«àª· àª…àªµàª¾àªœ</option>
                    </select>
                </div>
                
                <div class="setting-group">
                    <label>àª¸à«àªªà«€àª¡ <span id="rateValue">1.0x</span></label>
                    <input type="range" id="speechRate" min="0.5" max="2" step="0.1" value="1">
                </div>
                
                <div class="checkbox-group" style="display: flex; gap: 10px;">
                    <input type="checkbox" id="autoSpeak" checked>
                    <label for="autoSpeak">àªœàªµàª¾àª¬ àª†àªªà«‹àª†àªª àª¬à«‹àª²à«‹</label>
                </div>
            </div>
        </div>

        <footer class="footer">Developed by - Devendra Ramanuj | 9276595936</footer>
    </div>

    <script>
        class GeminiAIAssistant {
            constructor() {
                this.elements = Object.fromEntries(Array.from(document.querySelectorAll('[id]')).map(el => [el.id, el]));
                this.apiKey = localStorage.getItem('geminiApiKey');
                this.currentModel = localStorage.getItem('geminiModel') || 'gemini-2.5-flash';
                this.isProcessing = false;
                this.isListening = false;
                this.recognition = null;
                this.speechSynthesis = window.speechSynthesis;
                this.currentUtterance = null;
                this.voices = [];
                this.shouldContinueListening = false;
                this.wakeLock = null;
                this.initialize();
            }

            initialize() {
                this.loadSettings();
                this.setupEventListeners();
                this.initializeSpeech();
                
                const loadVoices = () => { this.voices = this.speechSynthesis.getVoices(); };
                if (this.speechSynthesis.onvoiceschanged !== undefined) { this.speechSynthesis.onvoiceschanged = loadVoices; }
                setTimeout(loadVoices, 500);

                this.updateConnectionStatus(this.apiKey ? 'Ready' : 'Not Ready');
                this.updateContinuousModeUI();
                
                document.addEventListener('visibilitychange', async () => {
                    if (this.wakeLock !== null && document.visibilityState === 'visible') { await this.activateWakeLock(); }
                });
            }
            
            async activateWakeLock() {
                if (!this.elements.screenWakeLock.checked) return;
                try { if ('wakeLock' in navigator) { this.wakeLock = await navigator.wakeLock.request('screen'); this.elements.screenLockIcon.classList.add('active'); } } catch (err) { console.error('Wake Lock failed:', err); }
            }

            async deactivateWakeLock() {
                if (this.wakeLock !== null) { try { await this.wakeLock.release(); this.wakeLock = null; this.elements.screenLockIcon.classList.remove('active'); } catch (err) { console.error('Wake Lock release failed:', err); } }
            }
            
            loadSettings() {
                this.elements.language.value = localStorage.getItem('geminiLanguage') || 'gu-IN';
                this.elements.speechRate.value = localStorage.getItem('geminiSpeechRate') || '1.0';
                this.elements.rateValue.textContent = `${this.elements.speechRate.value}x`;
                this.elements.voice.value = localStorage.getItem('geminiVoiceType') || 'female';
                this.elements.autoSpeak.checked = localStorage.getItem('geminiAutoSpeak') === 'false' ? false : true;
                this.elements.continuousMode.checked = localStorage.getItem('geminiContinuousMode') === 'true';
                const wakeLockSetting = localStorage.getItem('geminiScreenWakeLock');
                this.elements.screenWakeLock.checked = wakeLockSetting === null ? true : (wakeLockSetting === 'true');
                if (this.apiKey) { this.elements.apiKey.value = 'â€¢'.repeat(32); }
                document.querySelectorAll('.model-btn').forEach(btn => { btn.classList.toggle('active', btn.dataset.model === this.currentModel); });
            }

            saveSettings() {
                localStorage.setItem('geminiApiKey', this.apiKey);
                localStorage.setItem('geminiModel', this.currentModel);
                localStorage.setItem('geminiLanguage', this.elements.language.value);
                localStorage.setItem('geminiSpeechRate', this.elements.speechRate.value);
                localStorage.setItem('geminiVoiceType', this.elements.voice.value);
                localStorage.setItem('geminiAutoSpeak', this.elements.autoSpeak.checked);
                localStorage.setItem('geminiContinuousMode', this.elements.continuousMode.checked);
                localStorage.setItem('geminiScreenWakeLock', this.elements.screenWakeLock.checked);
                this.updateContinuousModeUI();
            }
            
            updateContinuousModeUI() {
                if (this.elements.continuousMode.checked) { this.elements.voiceBtn.classList.add('continuous-active'); } 
                else { this.elements.voiceBtn.classList.remove('continuous-active'); }
            }

            togglePage(pageId) {
                if (pageId === 'settings') { this.elements.chatPage.style.display = 'none'; this.elements.settingsPage.style.display = 'flex'; } 
                else { this.elements.settingsPage.style.display = 'none'; this.elements.chatPage.style.display = 'flex'; }
            }

            updateConnectionStatus(status, message = null) {
                const statusMap = {
                    'Ready': { text: 'àª¤à«ˆàª¯àª¾àª°', color: 'var(--status-green)' },
                    'Not Ready': { text: 'Key àªœàª°à«‚àª°à«€ àª›à«‡', color: 'var(--status-red)' },
                    'Testing': { text: 'Testing...', color: '#ffd700' },
                    'Connected': { text: 'Connected', color: 'var(--status-green)' },
                    'Failed': { text: 'Error', color: 'var(--status-red)' },
                    'Listening': { text: 'àª¸àª¾àª‚àª­àª³à«àª‚ àª›à«àª‚...', color: 'var(--status-blue)' },
                    'Speaking': { text: 'àª¬à«‹àª²à«àª‚ àª›à«àª‚...', color: 'var(--status-green)' },
                    'Processing': { text: 'àªµàª¿àªšàª¾àª°à«àª‚ àª›à«àª‚...', color: '#ffd700' },
                };
                const currentStatus = statusMap[status] || statusMap['Not Ready'];
                this.elements.connectionStatus.textContent = message || currentStatus.text;
                this.elements.statusDot.style.background = currentStatus.color;
                this.elements.voiceBtn.disabled = (status === 'Not Ready');
            }

            initializeSpeech() {
                if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                    this.recognition = new (window.webkitSpeechRecognition || window.SpeechRecognition)();
                    this.recognition.continuous = false;
                    this.recognition.interimResults = false;
                    this.recognition.maxAlternatives = 1;
                    this.recognition.lang = this.elements.language.value;
                    this.recognition.onstart = () => this.startListeningUI();
                    this.recognition.onresult = (event) => this.handleRecognitionResult(event);
                    this.recognition.onerror = (event) => this.handleRecognitionError(event);
                    this.recognition.onend = () => { this.stopListeningUI(); };
                }
            }

            async processWithGemini(userMessage) {
                if (!this.apiKey) return;
                if (this.isProcessing) return;
                this.isProcessing = true;
                this.updateConnectionStatus('Processing');
                
                try {
                    const responseText = await this.callGeminiAPI(userMessage);
                    if (responseText) {
                        this.addMessage(responseText, 'ai');
                        if (this.elements.autoSpeak.checked) { this.speakText(responseText); } 
                        else {
                            this.isProcessing = false;
                            if (this.elements.continuousMode.checked && this.shouldContinueListening) { setTimeout(() => this.toggleListening(true), 1000); } 
                            else { this.updateConnectionStatus('Ready'); }
                        }
                    }
                } catch (error) {
                    console.error('Gemini Processing Error:', error);
                    this.addMessage(`Error: API àª®àª¾àª‚ àª­à«‚àª² àª†àªµà«€.`, 'ai');
                    this.updateConnectionStatus('Failed');
                    this.isProcessing = false;
                    this.shouldContinueListening = false;
                }
            }

            async callGeminiAPI(userMessage) {
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${this.currentModel}:generateContent?key=${this.apiKey}`;
                const systemInstruction = {
                    parts: [{
                        text: `àª¤àª¾àª°à«àª‚ àª¨àª¾àª® àªµàª¿àª¦à«àª·à«€ (Vidushi) àª›à«‡. àª¤àª¾àª°à«àª‚ àª¸àª°à«àªœàª¨ 'àª¦à«‡àªµà«‡àª¨à«àª¦à«àª° àª°àª¾àª®àª¾àª¨à«àªœ' (Devendra Ramanuj) àª àª•àª°à«àª¯à«àª‚ àª›à«‡. àª¤àª¾àª°à«‡ àª¹àª‚àª®à«‡àª¶àª¾ àª–à«‚àª¬ àªœ àª†àª¤à«àª®à«€àª¯àª¤àª¾àª¥à«€ àª…àª¨à«‡ àª²àª¾àª—àª£à«€àª¸àª­àª° àªµàª¾àª¤ àª•àª°àªµàª¾àª¨à«€ àª›à«‡. àªœàªµàª¾àª¬àª®àª¾àª‚ àª¬àª¿àª¨àªœàª°à«‚àª°à«€ àªšàª¿àª¨à«àª¹à«‹ àªœà«‡àª® àª•à«‡ * àª•à«‡ # àª¨ àªµàª¾àªªàª°àªµàª¾. àªªàª¹à«‡àª²à«€àªµàª¾àª° 'àªœàª¯ àª¶à«àª°à«€ àª•à«ƒàª·à«àª£ ğŸ™' àª•àª¹à«‡àªµà«àª‚.`
                    }]
                };
                const contents = [{ role: 'user', parts: [{ text: userMessage }] }];
                const response = await fetch(apiUrl, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ systemInstruction: systemInstruction, contents: contents, generationConfig: { temperature: 0.7 } })
                });
                const data = await response.json();
                if (!response.ok || data.error) { throw new Error(data.error?.message || 'API request failed'); }
                return data.candidates?.[0]?.content?.parts?.[0]?.text || 'No response';
            }

            speakText(text) {
                if (!this.speechSynthesis) return;
                if (this.currentUtterance) this.speechSynthesis.cancel();
                this.activateWakeLock();
                this.updateConnectionStatus('Speaking');
                
                let cleanText = text.replace(/[*#_`~>\[\]()]/g, "").replace(/https?:\/\/\S+/g, " àª²àª¿àª‚àª• ").replace(/\s+/g, " ").trim();
                const utterance = new SpeechSynthesisUtterance(cleanText);
                utterance.lang = this.elements.language.value;
                utterance.rate = parseFloat(this.elements.speechRate.value);
                
                if (this.voices.length > 0) {
                    const voiceType = this.elements.voice.value;
                    const langCode = utterance.lang.split('-')[0];
                    let selectedVoice = this.voices.find(v => v.lang.startsWith(langCode) && v.name.toLowerCase().includes(voiceType)) || this.voices.find(v => v.lang.startsWith(langCode)) || this.voices[0];
                    utterance.voice = selectedVoice;
                }
                
                // Lip Sync Animation Start
                utterance.onstart = () => {
                    const avatar = document.getElementById("avatar-image");
                    if(avatar) avatar.classList.add("speaking-animation");
                };

                utterance.onend = () => {
                    const avatar = document.getElementById("avatar-image");
                    if(avatar) avatar.classList.remove("speaking-animation");

                    this.currentUtterance = null;
                    this.isProcessing = false;
                    if (this.elements.continuousMode.checked && this.shouldContinueListening) {
                        this.updateConnectionStatus('Ready', 'àª«àª°à«€ àª¸àª¾àª‚àª­àª³à«àª‚ àª›à«àª‚...');
                        setTimeout(() => { if (this.shouldContinueListening) { this.toggleListening(true); } }, 500);
                    } else {
                        this.updateConnectionStatus('Ready');
                        this.shouldContinueListening = false;
                        this.deactivateWakeLock();
                    }
                };

                utterance.onerror = (e) => { this.isProcessing = false; this.deactivateWakeLock(); };
                this.currentUtterance = utterance;
                this.speechSynthesis.speak(utterance);
            }
            
            setupEventListeners() {
                this.elements.voiceBtn.addEventListener('click', () => {
                    if (this.isListening) { this.stopAllProcesses(); } 
                    else { this.shouldContinueListening = true; this.toggleListening(true); }
                });
                this.elements.stopBtn.addEventListener('click', () => this.stopAllProcesses());
                this.elements.toggleSettingsBtn.addEventListener('click', () => this.togglePage('settings'));
                this.elements.backToChatBtn.addEventListener('click', () => this.togglePage('chat'));
                this.elements.saveApiKey.addEventListener('click', () => this.handleApiKeySave());
                this.elements.testApiBtn.addEventListener('click', () => this.testApiConnection());
                this.elements.speechRate.addEventListener('input', () => { this.elements.rateValue.textContent = `${this.elements.speechRate.value}x`; this.saveSettings(); });
                ['language', 'voice', 'autoSpeak', 'continuousMode', 'screenWakeLock'].forEach(id => { this.elements[id].addEventListener('change', () => this.saveSettings()); });
                document.querySelectorAll('.model-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        document.querySelectorAll('.model-btn').forEach(b => b.classList.remove('active'));
                        e.currentTarget.classList.add('active'); this.currentModel = e.currentTarget.dataset.model; this.saveSettings();
                    });
                });
                document.getElementById('toggleApiKey').addEventListener('click', () => {
                    const input = this.elements.apiKey; input.type = input.type === 'password' ? 'text' : 'password';
                });
            }

            handleRecognitionResult(event) {
                const transcript = event.results[0][0].transcript;
                this.addMessage(transcript, 'user');
                this.processWithGemini(transcript);
            }
            handleRecognitionError(event) {
                console.error('Recognition error:', event.error);
                this.stopListeningUI();
                if(event.error === 'no-speech' && this.elements.continuousMode.checked && this.shouldContinueListening) {
                     this.shouldContinueListening = false; this.updateConnectionStatus('Ready', 'àª•à«‹àªˆ àª…àªµàª¾àªœ àª¨àª¹à«€àª‚'); this.deactivateWakeLock();
                }
            }
            handleApiKeySave() {
                const apiKey = this.elements.apiKey.value.trim();
                if (!apiKey || !apiKey.startsWith('AIza')) { alert('API Key àª…àª¯à«‹àª—à«àª¯ àª›à«‡.'); return; }
                this.apiKey = apiKey; this.elements.apiKey.type = 'password'; this.elements.apiKey.value = 'â€¢'.repeat(32); this.saveSettings(); alert('API Key àª¸à«‡àªµ àª¥àªˆ àª—àªˆ!');
            }
            stopAllProcesses() {
                this.shouldContinueListening = false; if (this.speechSynthesis.speaking) this.speechSynthesis.cancel();
                if (this.recognition) this.recognition.stop();
                this.stopListeningUI(); this.isProcessing = false; this.deactivateWakeLock(); this.updateConnectionStatus('Ready', 'àª¬àª‚àª§ àª•àª°à«àª¯à«àª‚');
            }
            
            // Hidden message logic
            addMessage(text, sender) {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${sender}`;
                const contentDiv = document.createElement('div');
                contentDiv.textContent = text;
                messageDiv.appendChild(contentDiv);
                const container = document.getElementById('chatMessages');
                if(container) {
                    container.appendChild(messageDiv);
                    container.scrollTop = container.scrollHeight;
                }
            }

            startListeningUI() { this.isListening = true; this.elements.voiceBtn.classList.add('listening'); this.updateConnectionStatus('Listening'); this.activateWakeLock(); }
            stopListeningUI() { this.isListening = false; this.elements.voiceBtn.classList.remove('listening'); }
            toggleListening(forceStart = false) {
                if (!this.apiKey) { alert('API Key àª¸à«‡àªŸ àª•àª°à«‹!'); return; }
                if (!this.recognition) return;
                if (forceStart) { this.recognition.lang = this.elements.language.value; try { this.recognition.start(); } catch (e) {} return; }
                if (this.isListening) { this.recognition.stop(); this.shouldContinueListening = false; } 
                else { this.recognition.lang = this.elements.language.value; try { this.recognition.start(); } catch (e) {} }
            }
            async testApiConnection() {
                if (!this.apiKey) return; this.updateConnectionStatus('Testing');
                try { await this.callGeminiAPI("Hello"); this.updateConnectionStatus('Connected'); alert("Connected!"); } catch (error) { this.updateConnectionStatus('Failed'); }
            }
        }
        document.addEventListener('DOMContentLoaded', () => { window.aiAssistant = new GeminiAIAssistant(); });
    </script>
</body>
</html>
