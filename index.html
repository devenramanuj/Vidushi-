<!DOCTYPE html>
<html lang="gu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>àªµàª¿àª¦à«àª·à«€ AI Assistant</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            /* àª¸à«àª§àª¾àª°à«‹: àª¬à«‹àª¡à«€ àª¬à«‡àª•àª—à«àª°àª¾àª‰àª¨à«àª¡ àªªàª¾àª°àª¦àª°à«àª¶àª• àª•àª°à«àª¯à«àª‚ */
            --primary-bg: transparent; 
            --secondary-bg: rgba(30, 30, 30, 0.7); /* àªµàª§à« àªªàª¾àª°àª¦àª°à«àª¶àª• àªœà«‡àª¥à«€ àªµàª¿àª¡à«€àª¯à«‹ àª¦à«‡àª–àª¾àª¯ */
            --chat-bg: rgba(41, 41, 41, 0.9);
            --text-color: #ffffff;
            --accent-red: #8b0000;
            --border-color: #333333;
            --button-color: #444444;
            --status-green: #00ff00;
            --status-red: #ff0000;
            --status-blue: #00ffff;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        
        body {
            background: var(--primary-bg); /* àª¬à«àª²à«‡àª• àª•àª²àª° àª¹àªŸàª¾àªµà«€ àª¦à«€àª§à«‹ */
            min-height: 100vh;
            color: var(--text-color);
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            overflow: hidden; 
        }

        /* --- VIDEO BACKGROUND --- */
        #video-bg-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -10; /* àª¸à«Œàª¥à«€ àªªàª¾àª›àª³ */
            background-color: black; /* àªœà«‹ àªµàª¿àª¡à«€àª¯à«‹ àª²à«‹àª¡ àª¨ àª¥àª¾àª¯ àª¤à«‹ àª¬à«àª²à«‡àª• */
        }

        .bg-video {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            min-width: 100%;
            min-height: 100%;
            width: auto;
            height: auto;
            object-fit: cover;
        }

        #talking-video {
            display: none; 
        }
        /* --------------------------- */
        
        .container {
            width: 100%;
            max-width: 600px;
            background: var(--secondary-bg);
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.7);
            overflow: hidden;
            border: 1px solid var(--border-color);
            position: relative;
            display: flex;
            flex-direction: column;
            height: 85vh;
            backdrop-filter: blur(3px); 
        }
        
        header {
            background: rgba(30, 30, 30, 0.5);
            padding: 15px 20px;
            text-align: center;
            border-bottom: 1px solid var(--border-color);
            flex-shrink: 0;
        }
        
        h1 { font-size: 2.2rem; font-weight: 500; color: var(--text-color); }
        .header-line { height: 2px; background-color: var(--accent-red); width: 100%; margin-top: 5px; }
        
        .content-area { flex-grow: 1; position: relative; overflow: hidden; display: flex; }

        #chatPage, #settingsPage {
            padding: 20px;
            display: flex;
            flex-direction: column;
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0; left: 0;
            background: transparent; 
            transition: opacity 0.3s ease;
        }

        #settingsPage { display: none; z-index: 10; overflow-y: auto; background: rgba(30, 30, 30, 0.95); }
        
        .chat-container { flex-grow: 1; display: flex; flex-direction: column; height: 100%; overflow: hidden; }
        .chat-messages { flex-grow: 1; padding: 0 0 15px 0; overflow-y: auto; display: flex; flex-direction: column; gap: 15px; }

        .message { display: flex; gap: 10px; padding: 0 5px; }
        .message.user { justify-content: flex-end; }
        .message.ai { justify-content: flex-start; }
        
        .avatar {
            width: 30px; height: 30px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 14px; flex-shrink: 0; background: var(--button-color); color: var(--text-color);
        }
        
        .message-content {
            max-width: 85%; padding: 10px 15px; border-radius: 15px;
            line-height: 1.4; word-wrap: break-word; background: var(--chat-bg); border: 1px solid #333;
        }
        .user .message-content { background: #444; }
        
        #typingIndicator .message-content { background: #222; width: 50px; text-align: center; padding: 8px 15px; }
        .typing-indicator-dot {
            width: 6px; height: 6px; background: #aaa; border-radius: 50%;
            display: inline-block; margin: 0 2px; animation: typing 1.4s infinite;
        }
        @keyframes typing { 0%, 60%, 100% { transform: translateY(0); } 30% { transform: translateY(-4px); } }

        .voice-controls {
            padding: 10px 0 0 0; border-top: 1px solid var(--border-color);
            display: flex; flex-direction: column; align-items: center; gap: 10px; flex-shrink: 0;
        }
        
        .voice-btn {
            width: 70px; height: 70px; border-radius: 50%; background: var(--button-color);
            border: none; color: var(--text-color); font-size: 24px; cursor: pointer;
            transition: all 0.3s; display: flex; align-items: center; justify-content: center;
            position: relative; box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        .voice-btn:hover { background: #555; transform: scale(1.05); }
        .voice-btn.listening {
            background: var(--status-red); box-shadow: 0 0 0 0 rgba(255, 0, 0, 0.5); animation: pulse-ring 1.5s infinite;
        }
        .voice-btn.continuous-active::after {
            content: '\f021'; font-family: 'Font Awesome 6 Free'; font-weight: 900;
            position: absolute; top: 0; right: 0; background: var(--status-blue);
            color: black; font-size: 10px; width: 20px; height: 20px;
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            border: 2px solid var(--secondary-bg);
        }

        #stopBtn {
            width: 50px; height: 50px; border-radius: 50%; background: #ff0000; border: 2px solid #8b0000;
            color: white; font-size: 20px; display: flex; align-items: center; justify-content: center;
            cursor: pointer; margin-top: 10px; transition: all 0.3s; box-shadow: 0 4px 10px rgba(255, 0, 0, 0.2);
        }
        #stopBtn:hover { background: #cc0000; transform: scale(1.1); }
        
        @keyframes pulse-ring {
            0% { box-shadow: 0 0 0 0 rgba(255, 0, 0, 0.5); }
            70% { box-shadow: 0 0 0 15px rgba(255, 0, 0, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 0, 0, 0); }
        }

        .voice-status { font-size: 14px; color: #aaa; min-height: 20px; text-align: center; font-weight: bold; text-shadow: 1px 1px 2px black; }

        .status-bar {
            display: flex; justify-content: space-between; align-items: center;
            padding: 10px 0; border-bottom: 1px solid var(--border-color); margin-bottom: 15px;
        }
        .status-indicator { display: flex; align-items: center; gap: 8px; }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--status-red); }
        .screen-lock-status { font-size: 10px; color: #666; margin-left: 5px; display: none; }
        .screen-lock-status.active { display: inline; color: var(--status-green); }

        .action-buttons button {
            background: #333; color: white; border: none; padding: 8px 12px;
            border-radius: 8px; cursor: pointer; transition: background 0.3s;
        }
        .action-buttons button:hover { background: #555; }
        
        #toggleSettingsBtn {
            position: absolute; top: 20px; right: 20px; z-index: 20; background: var(--button-color);
            border: none; color: var(--text-color); width: 40px; height: 40px; border-radius: 50%;
            cursor: pointer; font-size: 18px; transition: background 0.3s;
        }
        #toggleSettingsBtn:hover { background: #555; }

        .settings-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 25px; padding-bottom: 15px; border-bottom: 1px solid var(--border-color);
        }
        .settings-header h2 { font-size: 1.8rem; color: var(--text-color); }
        #backToChatBtn { background: var(--button-color); color: var(--text-color); border: none; padding: 8px 15px; border-radius: 8px; cursor: pointer; }

        .setting-group { margin-bottom: 20px; padding-bottom: 10px; border-bottom: 1px dashed #333; }
        .setting-group label { display: block; margin-bottom: 8px; font-size: 14px; color: #ccc; }
        .api-input-group, .setting-group input, .setting-group select, .setting-group button {
            width: 100%; padding: 10px 12px; background: var(--chat-bg);
            border: 1px solid #444; border-radius: 6px; color: white; font-size: 14px;
        }

        .checkbox-group { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
        
        .toggle-switch { position: relative; display: inline-block; width: 50px; height: 24px; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .slider {
            position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
            background-color: #444; transition: .4s; border-radius: 34px;
        }
        .slider:before {
            position: absolute; content: ""; height: 16px; width: 16px; left: 4px; bottom: 4px;
            background-color: white; transition: .4s; border-radius: 50%;
        }
        input:checked + .slider { background-color: var(--status-green); }
        input:checked + .slider:before { transform: translateX(26px); }

        .footer { text-align: center; padding: 10px; font-size: 12px; color: #666; border-top: 1px solid var(--border-color); background: var(--secondary-bg); flex-shrink: 0; }
    </style>
</head>
<body>
    
    <div id="video-bg-container">
        <video id="silent-video" class="bg-video" autoplay muted loop playsinline>
            <source src="silent.mp4" type="video/mp4">
        </video>
        
        <video id="talking-video" class="bg-video" muted loop playsinline>
            <source src="talking.mp4" type="video/mp4">
        </video>
    </div>

    <div class="container">
        <button id="toggleSettingsBtn" title="àª¸à«‡àªŸàª¿àª‚àª—à«àª¸"><i class="fas fa-cog"></i></button>

        <header>
            <h1>àªµàª¿àª¦à«àª·à«€</h1>
            <div class="header-line"></div>
        </header>
        
        <div class="content-area">
            <div id="chatPage">
                <div class="chat-container">
                    <div class="status-bar">
                        <div class="status-indicator">
                            <div class="status-dot" id="statusDot"></div>
                            <span id="connectionStatus">Key àªœàª°à«‚àª°à«€ àª›à«‡</span>
                            <i class="fas fa-sun screen-lock-status" id="screenLockIcon" title="Screen Awake Active"></i>
                        </div>
                        <div class="action-buttons">
                            <button id="clearBtn" title="Chat Clear àª•àª°à«‹"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>
                    <div class="chat-messages" id="chatMessages">
                        <div class="message ai">
                            <div class="avatar"><i class="fas fa-robot"></i></div>
                            <div class="message-content">àªœàª¯ àª¶à«àª°à«€ àª•à«ƒàª·à«àª£ ğŸ™! àª¹à«àª‚ àªµàª¿àª¦à«àª·à«€ àª›à«àª‚. àª†àªª àª•à«‡àªµà«€ àª°à«€àª¤à«‡ àª®àª¦àª¦ àª•àª°à«€ àª¶àª•à«àª‚?</div>
                        </div>
                    </div>
                </div>
                
                <div class="voice-controls">
                    <div class="voice-status" id="voiceStatus">àª¸à«‡àªŸàª¿àª‚àª—à«àª¸àª®àª¾àª‚ Key àª¸à«‡àªµ àª•àª°à«‹</div>
                    <button class="voice-btn" id="voiceBtn" title="àª¬à«‹àª²àªµàª¾ àª®àª¾àªŸà«‡ àª•à«àª²àª¿àª• àª•àª°à«‹">
                        <i class="fas fa-microphone"></i>
                    </button>
                    <button id="stopBtn" title="àªµàª¾àª¤àªšà«€àª¤ àª¬àª‚àª§ àª•àª°à«‹ (Mute)">
                        <i class="fas fa-volume-xmark"></i>
                    </button>
                </div>
            </div>
            
            <div id="settingsPage">
                <div class="settings-header">
                    <h2>àª¸à«‡àªŸàª¿àª‚àª—à«àª¸</h2>
                    <button id="backToChatBtn"><i class="fas fa-arrow-left"></i> àªªàª¾àª›àª¾ àªœàª¾àª“</button>
                </div>

                <div class="setting-group">
                    <label for="apiKey"><i class="fas fa-key"></i> Gemini API Key</label>
                    <div class="api-input-group" style="display: flex; gap: 5px;">
                        <input type="password" id="apiKey" placeholder="àª¤àª®àª¾àª°à«€ Gemini API key àª¦àª¾àª–àª² àª•àª°à«‹">
                        <button type="button" id="toggleApiKey" style="width: 40px; flex-shrink: 0; padding: 0;"><i class="fas fa-eye"></i></button>
                    </div>
                    <button id="saveApiKey" style="margin-top: 10px;"><i class="fas fa-save"></i> Key àª¸à«‡àªµ àª•àª°à«‹</button>
                    <button id="testApiBtn" style="margin-top: 10px; background: #333;"><i class="fas fa-bolt"></i> API Test</button>
                </div>

                <div class="setting-group" style="border: 1px solid #555; padding: 15px; border-radius: 8px; background: #252525;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <label for="continuousMode" style="margin: 0; color: #fff; font-weight: bold;">
                            <i class="fas fa-comments"></i> àª¸àª¤àª¤ àªµàª¾àª¤àªšà«€àª¤ (Continuous)
                        </label>
                        <label class="toggle-switch">
                            <input type="checkbox" id="continuousMode">
                            <span class="slider"></span>
                        </label>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center; border-top: 1px solid #444; padding-top: 10px;">
                        <label for="screenWakeLock" style="margin: 0; color: #ddd; font-size: 14px;">
                            <i class="fas fa-sun"></i> àª¸à«àª•à«àª°à«€àª¨ àªšàª¾àª²à« àª°àª¾àª–à«‹ (Wake Lock)
                        </label>
                        <label class="toggle-switch" style="width: 40px; height: 20px;">
                            <input type="checkbox" id="screenWakeLock" checked>
                            <span class="slider"></span>
                        </label>
                    </div>
                    <p style="font-size: 11px; color: #aaa; margin-top: 5px;">àª¨à«‹àª‚àª§: àª¸à«àª•à«àª°à«€àª¨ àª¬àª‚àª§ àª¥àªµàª¾àª¥à«€ àªµàª¾àª¤àªšà«€àª¤ àª…àªŸàª•à«€ àªœàª¾àª¯ àª›à«‡, àª¤à«‡àª¥à«€ àª† àªšàª¾àª²à« àª°àª¾àª–àªµà«àª‚ àª¹àª¿àª¤àª¾àªµàª¹ àª›à«‡.</p>
                </div>
                
                <div class="setting-group">
                    <label><i class="fas fa-brain"></i> AI Model (àªªàª¸àª‚àª¦ àª•àª°à«‹)</label>
                    <select id="modelSelect">
                        <option value="gemini-2.5-flash">Gemini 2.5 Flash (àª¤àª®àª¾àª°à«€ àªªàª¸àª‚àª¦)</option>
                        <option value="gemini-2.5-pro">Gemini 2.5 Pro (àª¤àª®àª¾àª°à«€ àªªàª¸àª‚àª¦)</option>
                        <option value="gemini-1.5-flash">Gemini 1.5 Flash</option>
                        <option value="gemini-1.5-pro">Gemini 1.5 Pro</option>
                        <option value="gemini-1.0-pro">Gemini 1.0 Pro</option>
                    </select>
                </div>
                
                <div class="setting-group">
                    <label for="language"><i class="fas fa-language"></i> àª­àª¾àª·àª¾ (Language)</label>
                    <select id="language">
                        <option value="gu-IN">Gujarati</option>
                        <option value="en-US">English (US)</option>
                        <option value="hi-IN">Hindi</option>
                    </select>
                </div>
                
                <div class="setting-group">
                    <label for="voice"><i class="fas fa-microphone-alt"></i> àª…àªµàª¾àªœàª¨à«‹ àªªà«àª°àª•àª¾àª°</label>
                    <select id="voice">
                        <option value="female">àª¸à«àª¤à«àª°à«€ àª…àªµàª¾àªœ</option>
                        <option value="male">àªªà«àª°à«àª· àª…àªµàª¾àªœ</option>
                    </select>
                </div>
                
                <div class="setting-group">
                    <label for="speechRate"><i class="fas fa-tachometer-alt"></i> àª¬à«‹àª²àªµàª¾àª¨à«€ àª—àª¤àª¿ (Speed) <span id="rateValue">1.0x</span></label>
                    <input type="range" id="speechRate" min="0.5" max="2" step="0.1" value="1">
                </div>
                
                <div class="checkbox-group">
                    <input type="checkbox" id="autoSpeak" checked>
                    <label for="autoSpeak">àªœàªµàª¾àª¬ àª†àªªà«‹àª†àªª àª¬à«‹àª²à«‹</label>
                </div>
            </div>
        </div>

        <footer class="footer">Developed by - Devendra Ramanuj | 9276595936</footer>
    </div>

    <script>
        class GeminiAIAssistant {
            constructor() {
                this.elements = Object.fromEntries(Array.from(document.querySelectorAll('[id]')).map(el => [el.id, el]));
                
                // Video Elements
                this.silentVideo = document.getElementById('silent-video');
                this.talkingVideo = document.getElementById('talking-video');

                this.apiKey = localStorage.getItem('geminiApiKey');
                
                // Set default to 2.5-flash as requested by user
                this.currentModel = localStorage.getItem('geminiModel') || 'gemini-2.5-flash';
                
                this.isProcessing = false;
                this.isListening = false;
                this.recognition = null;
                this.speechSynthesis = window.speechSynthesis;
                this.currentUtterance = null;
                this.voices = [];
                this.shouldContinueListening = false;
                this.wakeLock = null;
                this.initialize();
            }

            initialize() {
                this.loadSettings();
                this.setupEventListeners();
                this.initializeSpeech();
                const loadVoices = () => { this.voices = this.speechSynthesis.getVoices(); };
                if (this.speechSynthesis.onvoiceschanged !== undefined) { this.speechSynthesis.onvoiceschanged = loadVoices; }
                setTimeout(loadVoices, 500);
                this.updateConnectionStatus(this.apiKey ? 'Ready' : 'Not Ready');
                this.updateContinuousModeUI();
                document.addEventListener('visibilitychange', async () => {
                    if (this.wakeLock !== null && document.visibilityState === 'visible') { await this.activateWakeLock(); }
                });
            }
            
            // --- VIDEO CONTROL FUNCTION ---
            setVideoTalking(isTalking) {
                if (isTalking) {
                    this.silentVideo.style.display = 'none';
                    this.talkingVideo.style.display = 'block';
                    this.talkingVideo.play().catch(e => console.log('Video play error:', e));
                } else {
                    this.silentVideo.style.display = 'block';
                    this.talkingVideo.style.display = 'none';
                    this.talkingVideo.pause();
                    this.talkingVideo.currentTime = 0;
                }
            }
            // -----------------------------

            async activateWakeLock() {
                if (!this.elements.screenWakeLock.checked) return;
                try {
                    if ('wakeLock' in navigator) {
                        this.wakeLock = await navigator.wakeLock.request('screen');
                        this.elements.screenLockIcon.classList.add('active');
                    }
                } catch (err) { console.error('Wake Lock failed:', err); }
            }

            async deactivateWakeLock() {
                if (this.wakeLock !== null) {
                    try {
                        await this.wakeLock.release();
                        this.wakeLock = null;
                        this.elements.screenLockIcon.classList.remove('active');
                    } catch (err) { console.error('Wake Lock release failed:', err); }
                }
            }
            
            loadSettings() {
                this.elements.language.value = localStorage.getItem('geminiLanguage') || 'gu-IN';
                this.elements.speechRate.value = localStorage.getItem('geminiSpeechRate') || '1.0';
                this.elements.rateValue.textContent = `${this.elements.speechRate.value}x`;
                this.elements.voice.value = localStorage.getItem('geminiVoiceType') || 'female';
                this.elements.autoSpeak.checked = localStorage.getItem('geminiAutoSpeak') === 'false' ? false : true;
                this.elements.continuousMode.checked = localStorage.getItem('geminiContinuousMode') === 'true';
                const wakeLockSetting = localStorage.getItem('geminiScreenWakeLock');
                this.elements.screenWakeLock.checked = wakeLockSetting === null ? true : (wakeLockSetting === 'true');
                
                // Ensure the dropdown has the correct selected value
                this.elements.modelSelect.value = this.currentModel;

                if (this.apiKey) { this.elements.apiKey.value = 'â€¢'.repeat(32); }
            }

            saveSettings() {
                localStorage.setItem('geminiApiKey', this.apiKey);
                localStorage.setItem('geminiModel', this.currentModel);
                localStorage.setItem('geminiLanguage', this.elements.language.value);
                localStorage.setItem('geminiSpeechRate', this.elements.speechRate.value);
                localStorage.setItem('geminiVoiceType', this.elements.voice.value);
                localStorage.setItem('geminiAutoSpeak', this.elements.autoSpeak.checked);
                localStorage.setItem('geminiContinuousMode', this.elements.continuousMode.checked);
                localStorage.setItem('geminiScreenWakeLock', this.elements.screenWakeLock.checked);
                this.updateContinuousModeUI();
            }
            
            updateContinuousModeUI() {
                if (this.elements.continuousMode.checked) { this.elements.voiceBtn.classList.add('continuous-active'); } 
                else { this.elements.voiceBtn.classList.remove('continuous-active'); }
            }

            togglePage(pageId) {
                const chatPage = this.elements.chatPage;
                const settingsPage = this.elements.settingsPage;
                if (pageId === 'settings') { chatPage.style.display = 'none'; settingsPage.style.display = 'flex'; } 
                else { settingsPage.style.display = 'none'; chatPage.style.display = 'flex'; }
            }

            updateConnectionStatus(status, message = null) {
                const statusMap = {
                    'Ready': { text: 'âœ… àªµàª¾àª¤àªšà«€àª¤ àª®àª¾àªŸà«‡ àª¤à«ˆàª¯àª¾àª°', color: 'var(--status-green)' },
                    'Not Ready': { text: 'Key àªœàª°à«‚àª°à«€ àª›à«‡', color: 'var(--status-red)' },
                    'Testing': { text: 'API Testing...', color: '#ffd700' },
                    'Connected': { text: 'âœ… API Connected', color: 'var(--status-green)' },
                    'Failed': { text: 'âŒ API àª­à«‚àª²', color: 'var(--status-red)' },
                    'Listening': { text: 'ğŸ¤ àª¸àª¾àª‚àª­àª³à«€ àª°àª¹à«€ àª›à«‡...', color: 'var(--status-blue)' },
                    'Speaking': { text: 'ğŸ”Š àª¬à«‹àª²à«€ àª°àª¹à«€ àª›à«‡...', color: 'var(--status-green)' },
                    'Processing': { text: 'ğŸ§  àªµàª¿àªšàª¾àª° àª•àª°à«€ àª°àª¹à«€ àª›à«‡...', color: '#ffd700' },
                };
                const currentStatus = statusMap[status] || statusMap['Not Ready'];
                this.elements.connectionStatus.textContent = message || currentStatus.text;
                this.elements.statusDot.style.background = currentStatus.color;
                this.elements.voiceStatus.textContent = message || currentStatus.text;
                this.elements.voiceBtn.disabled = (status === 'Not Ready');
            }

            showNotification(message, type = 'info') { console.log(`[${type}]: ${message}`); }

            initializeSpeech() {
                if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                    this.recognition = new (window.webkitSpeechRecognition || window.SpeechRecognition)();
                    this.recognition.continuous = false;
                    this.recognition.interimResults = false;
                    this.recognition.maxAlternatives = 1;
                    this.recognition.lang = this.elements.language.value;
                    this.recognition.onstart = () => this.startListeningUI();
                    this.recognition.onresult = (event) => this.handleRecognitionResult(event);
                    this.recognition.onerror = (event) => this.handleRecognitionError(event);
                    this.recognition.onend = () => { this.stopListeningUI(); };
                }
            }

            async processWithGemini(userMessage) {
                if (!this.apiKey) return;
                if (this.isProcessing) return;
                this.isProcessing = true;
                this.updateConnectionStatus('Processing');
                this.showTypingIndicator();
                try {
                    const responseText = await this.callGeminiAPI(userMessage);
                    this.removeTypingIndicator();
                    if (responseText) {
                        this.addMessage(responseText, 'ai');
                        if (this.elements.autoSpeak.checked) { this.speakText(responseText); } 
                        else {
                            this.isProcessing = false;
                            if (this.elements.continuousMode.checked && this.shouldContinueListening) {
                                setTimeout(() => this.toggleListening(true), 1000);
                            } else { this.updateConnectionStatus('Ready'); }
                        }
                    }
                } catch (error) {
                    console.error('Gemini Processing Error:', error);
                    this.removeTypingIndicator();
                    const errorMsg = error.message || 'Unknown Error';
                    this.addMessage(`Error: API àª®àª¾àª‚ àª­à«‚àª² àª†àªµà«€. (${errorMsg})`, 'ai');
                    this.updateConnectionStatus('Failed');
                    this.isProcessing = false;
                    this.shouldContinueListening = false;
                }
            }

            async callGeminiAPI(userMessage) {
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${this.currentModel}:generateContent?key=${this.apiKey}`;
                
                const systemInstruction = {
                    parts: [{
                        text: `àª¤àª¾àª°à«àª‚ àª¨àª¾àª® àªµàª¿àª¦à«àª·à«€ (Vidushi) àª›à«‡. àª¤àª¾àª°à«àª‚ àª¸àª°à«àªœàª¨ 'àª¦à«‡àªµà«‡àª¨à«àª¦à«àª° àª°àª¾àª®àª¾àª¨à«àªœ' (Devendra Ramanuj) àª àª•àª°à«àª¯à«àª‚ àª›à«‡. 
                               àª¤àª¾àª°à«‡ àª¹àª‚àª®à«‡àª¶àª¾ àª–à«‚àª¬ àªœ àª†àª¤à«àª®à«€àª¯àª¤àª¾àª¥à«€ àª…àª¨à«‡ àª²àª¾àª—àª£à«€àª¸àª­àª° àªµàª¾àª¤ àª•àª°àªµàª¾àª¨à«€ àª›à«‡.
                               àª¨àª¿àª¯àª®à«‹:
                               1. àªœà«àª¯àª¾àª°à«‡ àªªàª£ àªªàª¹à«‡àª²à«€àªµàª¾àª° àªµàª¾àª¤ àª¥àª¾àª¯ àª¤à«àª¯àª¾àª°à«‡ 'àªœàª¯ àª¶à«àª°à«€ àª•à«ƒàª·à«àª£ ğŸ™' àª¥à«€ àª¶àª°à«‚àª†àª¤ àª•àª°àªµà«€.
                               2. àª¸àª¾àª®àª¾àª¨à«àª¯ àªªà«àª°àª¶à«àª¨à«‹àª¨àª¾ àª¸àª°àª³ àª…àª¨à«‡ àªŸà«‚àª‚àª•àª®àª¾àª‚ àªœàªµàª¾àª¬ àª†àªªàªµàª¾.
                               3. àªœà«‹ àªªà«àª°àª¶à«àª¨ àª—àª¹àª¨, àª†àª§à«àª¯àª¾àª¤à«àª®àª¿àª• àª•à«‡ àªœàªŸàª¿àª² àª¹à«‹àª¯, àª¤à«‹ àªªàª¹à«‡àª²àª¾ àªŸà«‚àª‚àª•àª®àª¾àª‚ àª•àª¹à«€àª¨à«‡ àªªà«‚àª›àªµà«àª‚ àª•à«‡ "àª¶à«àª‚ àª†àªª àª†àª¨àª¾ àªµàª¿àª¶à«‡ àªµàª§à« àªµàª¿àª¸à«àª¤à«ƒàª¤ àª®àª¾àª¹àª¿àª¤à«€ àªˆàªšà«àª›à«‹ àª›à«‹?"
                               4. àªœàªµàª¾àª¬àª®àª¾àª‚ àª¬àª¿àª¨àªœàª°à«‚àª°à«€ àªšàª¿àª¨à«àª¹à«‹ (àªœà«‡àª® àª•à«‡ *, #) àª¨ àªµàª¾àªªàª°àªµàª¾. àª¸àª¾àª¦à«àª‚ àª²àª–àª¾àª£ àª²àª–àªµà«àª‚.
                               `
                    }]
                };

                const contents = [{ role: 'user', parts: [{ text: userMessage }] }];
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        systemInstruction: systemInstruction,
                        contents: contents, 
                        generationConfig: { temperature: 0.7 } 
                    })
                });
                const data = await response.json();
                if (!response.ok || data.error) {
                    throw new Error(data.error?.message || 'API request failed');
                }
                return data.candidates?.[0]?.content?.parts?.[0]?.text || 'No response';
            }

            speakText(text) {
                if (!this.speechSynthesis) return;
                if (this.currentUtterance) this.speechSynthesis.cancel();
                this.activateWakeLock();
                this.updateConnectionStatus('Speaking');
                
                // --- START LIP SYNC ---
                this.setVideoTalking(true);
                // ----------------------
                
                let cleanText = text.replace(/[*#_`~>\[\]()]/g, ""); 
                cleanText = cleanText.replace(/https?:\/\/\S+/g, " àª²àª¿àª‚àª• ");
                cleanText = cleanText.replace(/\s+/g, " ").trim();

                const utterance = new SpeechSynthesisUtterance(cleanText);
                utterance.lang = this.elements.language.value;
                utterance.rate = parseFloat(this.elements.speechRate.value);
                
                if (this.voices.length > 0) {
                    const voiceType = this.elements.voice.value;
                    const langCode = utterance.lang.split('-')[0];
                    let selectedVoice = this.voices.find(v => v.lang.startsWith(langCode) && v.name.toLowerCase().includes(voiceType)) || 
                                        this.voices.find(v => v.lang.startsWith(langCode)) || this.voices[0];
                    utterance.voice = selectedVoice;
                }
                
                utterance.onend = () => {
                    // --- STOP LIP SYNC ---
                    this.setVideoTalking(false);
                    // ---------------------

                    this.currentUtterance = null;
                    this.isProcessing = false;
                    if (this.elements.continuousMode.checked && this.shouldContinueListening) {
                        this.updateConnectionStatus('Ready', 'àª«àª°à«€ àª¸àª¾àª‚àª­àª³à«àª‚ àª›à«àª‚...');
                        setTimeout(() => { if (this.shouldContinueListening) { this.toggleListening(true); } }, 500);
                    } else {
                        this.updateConnectionStatus('Ready');
                        this.shouldContinueListening = false;
                        this.deactivateWakeLock();
                    }
                };
                utterance.onerror = (e) => {
                    console.error('Speech Error:', e);
                    // --- STOP LIP SYNC ON ERROR ---
                    this.setVideoTalking(false);
                    // -----------------------------
                    this.isProcessing = false;
                    this.deactivateWakeLock();
                };
                this.currentUtterance = utterance;
                this.speechSynthesis.speak(utterance);
            }
            
            setupEventListeners() {
                this.elements.voiceBtn.addEventListener('click', () => {
                    if (this.isListening) { this.stopAllProcesses(); } 
                    else { this.shouldContinueListening = true; this.toggleListening(true); }
                });
                this.elements.stopBtn.addEventListener('click', () => this.stopAllProcesses());
                this.elements.clearBtn.addEventListener('click', () => this.clearChat());
                this.elements.toggleSettingsBtn.addEventListener('click', () => this.togglePage('settings'));
                this.elements.backToChatBtn.addEventListener('click', () => this.togglePage('chat'));
                this.elements.saveApiKey.addEventListener('click', () => this.handleApiKeySave());
                
                this.elements.testApiBtn.addEventListener('click', async () => {
                    const btn = this.elements.testApiBtn;
                    const originalText = '<i class="fas fa-bolt"></i> API Test';
                    
                    let keyToTest = this.apiKey;
                    const inputKey = this.elements.apiKey.value.trim();
                    if (!keyToTest && inputKey.startsWith('AIza')) { keyToTest = inputKey; }

                    if (!keyToTest) {
                        btn.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Key àª¨àª¾àª–à«‹';
                        setTimeout(() => btn.innerHTML = originalText, 2000);
                        return;
                    }

                    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Testing...';
                    btn.disabled = true;

                    try {
                        const model = this.currentModel;
                        const url = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${keyToTest}`;
                        const response = await fetch(url, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ contents: [{ parts: [{ text: "Hello" }] }] })
                        });

                        if (response.ok) {
                            btn.innerHTML = '<i class="fas fa-check"></i> àª¸àª«àª³ (Success)';
                            btn.style.background = 'var(--status-green)';
                            btn.style.color = 'black';
                            this.updateConnectionStatus('Connected');
                        } else {
                            throw new Error('Failed');
                        }
                    } catch (error) {
                        btn.innerHTML = '<i class="fas fa-times"></i> àª¨àª¿àª·à«àª«àª³ (Failed)';
                        btn.style.background = 'var(--status-red)';
                    }

                    setTimeout(() => {
                        btn.innerHTML = originalText;
                        btn.style.background = '#333';
                        btn.style.color = 'white';
                        btn.disabled = false;
                    }, 3000);
                });

                this.elements.speechRate.addEventListener('input', () => {
                    this.elements.rateValue.textContent = `${this.elements.speechRate.value}x`;
                    this.saveSettings();
                });
                ['language', 'voice', 'autoSpeak', 'continuousMode', 'screenWakeLock'].forEach(id => {
                    this.elements[id].addEventListener('change', () => this.saveSettings());
                });

                // Listen for Model Select changes
                this.elements.modelSelect.addEventListener('change', (e) => {
                    this.currentModel = e.target.value;
                    this.saveSettings();
                });

                document.getElementById('toggleApiKey').addEventListener('click', () => {
                    const input = this.elements.apiKey;
                    input.type = input.type === 'password' ? 'text' : 'password';
                });
            }

            handleRecognitionResult(event) {
                const transcript = event.results[0][0].transcript;
                this.addMessage(transcript, 'user');
                this.processWithGemini(transcript);
            }
            
            handleRecognitionError(event) {
                console.error('Recognition error:', event.error);
                this.stopListeningUI();
                if(event.error === 'no-speech' && this.elements.continuousMode.checked && this.shouldContinueListening) {
                     this.shouldContinueListening = false;
                     this.updateConnectionStatus('Ready', 'àª•à«‹àªˆ àª…àªµàª¾àªœ àª¨àª¹à«€àª‚ - àª®à«‹àª¡ àª¬àª‚àª§');
                     this.deactivateWakeLock();
                }
            }

            handleApiKeySave() {
                const apiKey = this.elements.apiKey.value.trim();
                if (!apiKey || !apiKey.startsWith('AIza')) {
                    this.showNotification('API Key àª…àª¯à«‹àª—à«àª¯ àª›à«‡.', 'error'); return;
                }
                this.apiKey = apiKey;
                this.elements.apiKey.type = 'password';
                this.elements.apiKey.value = 'â€¢'.repeat(32);
                this.saveSettings();
                const saveBtn = this.elements.saveApiKey;
                const originalText = saveBtn.innerHTML;
                saveBtn.innerHTML = '<i class="fas fa-check"></i> àª¸à«‡àªµ àª¥àªˆ àª—àªˆ';
                setTimeout(() => saveBtn.innerHTML = originalText, 2000);
            }

            stopAllProcesses() {
                this.shouldContinueListening = false;
                if (this.speechSynthesis.speaking) this.speechSynthesis.cancel();
                if (this.recognition) this.recognition.stop();
                this.removeTypingIndicator();
                this.stopListeningUI();
                this.isProcessing = false;
                this.deactivateWakeLock();
                this.updateConnectionStatus('Ready', 'àªµàª¾àª¤àªšà«€àª¤ àª¬àª‚àª§ àª•àª°à«€');
                // --- Stop Video ---
                this.setVideoTalking(false);
            }

            addMessage(text, sender) {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${sender}`;
                const avatarDiv = document.createElement('div');
                avatarDiv.className = 'avatar';
                avatarDiv.innerHTML = sender === 'user' ? '<i class="fas fa-user"></i>' : '<i class="fas fa-robot"></i>';
                const contentDiv = document.createElement('div');
                contentDiv.className = 'message-content';
                contentDiv.textContent = text;
                messageDiv.appendChild(avatarDiv);
                messageDiv.appendChild(contentDiv);
                this.elements.chatMessages.appendChild(messageDiv);
                this.elements.chatMessages.scrollTop = this.elements.chatMessages.scrollHeight;
            }

            showTypingIndicator() {
                this.removeTypingIndicator();
                const typingDiv = document.createElement('div');
                typingDiv.className = 'message ai';
                typingDiv.id = 'typingIndicator';
                typingDiv.innerHTML = `<div class="avatar"><i class="fas fa-robot"></i></div><div class="message-content"><span class="typing-indicator-dot"></span><span class="typing-indicator-dot"></span><span class="typing-indicator-dot"></span></div>`;
                this.elements.chatMessages.appendChild(typingDiv);
                this.elements.chatMessages.scrollTop = this.elements.chatMessages.scrollHeight;
            }

            removeTypingIndicator() {
                const indicator = document.getElementById('typingIndicator');
                if (indicator) indicator.remove();
            }
            
            startListeningUI() {
                this.isListening = true;
                this.elements.voiceBtn.classList.add('listening');
                this.updateConnectionStatus('Listening');
                this.activateWakeLock();
            }

            stopListeningUI() {
                this.isListening = false;
                this.elements.voiceBtn.classList.remove('listening');
            }

            toggleListening(forceStart = false) {
                if (!this.apiKey) { this.showNotification('API Key àªœàª°à«‚àª°à«€ àª›à«‡', 'error'); return; }
                if (!this.recognition) return;
                if (forceStart) {
                    this.recognition.lang = this.elements.language.value;
                    try { this.recognition.start(); } catch (e) { console.log('Already started'); }
                    return;
                }
                if (this.isListening) {
                    this.recognition.stop();
                    this.shouldContinueListening = false;
                } else {
                    this.recognition.lang = this.elements.language.value;
                    try { this.recognition.start(); } catch (e) { console.error(e); }
                }
            }

            clearChat() {
                this.elements.chatMessages.innerHTML = `<div class="message ai"><div class="avatar"><i class="fas fa-robot"></i></div><div class="message-content">àªœàª¯ àª¶à«àª°à«€ àª•à«ƒàª·à«àª£ ğŸ™! àª¹à«àª‚ àªµàª¿àª¦à«àª·à«€ àª›à«àª‚. àª†àªª àª•à«‡àªµà«€ àª°à«€àª¤à«‡ àª®àª¦àª¦ àª•àª°à«€ àª¶àª•à«àª‚?</div></div>`;
                this.stopAllProcesses();
            }
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            window.aiAssistant = new GeminiAIAssistant();
        });
    </script>
</body>
</html>
