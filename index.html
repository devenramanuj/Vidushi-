<!DOCTYPE html>
<html lang="gu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vidushi - AI</title>
    <style>
        /* --- CSS Styles --- */
        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            background-color: #000;
            font-family: 'Arial', sans-serif;
        }

        #main-container {
            position: relative;
            width: 100%;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }

        /* Video Layer */
        video {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            min-width: 100%;
            min-height: 100%;
            width: auto;
            height: auto;
            object-fit: cover;
            z-index: 1;
        }

        #talking-video {
            display: none;
            z-index: 2;
        }

        /* --- Settings Button (Top Right) --- */
        #settings-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 20;
            background: rgba(0, 0, 0, 0.6);
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.5);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            font-size: 24px;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: 0.3s;
        }

        #settings-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: rotate(90deg);
        }

        /* --- Settings Modal --- */
        #settings-modal {
            display: none;
            position: absolute;
            top: 80px;
            right: 20px;
            z-index: 21;
            background: rgba(0, 0, 0, 0.85);
            padding: 20px;
            border-radius: 15px;
            width: 300px;
            border: 1px solid #ff9933;
            color: white;
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
        }

        .setting-item {
            margin-bottom: 15px;
        }

        .setting-item label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #ff9933;
        }

        .setting-item input, .setting-item select {
            width: 100%;
            padding: 8px;
            border-radius: 5px;
            border: none;
            background: rgba(255, 255, 255, 0.9);
            font-size: 14px;
        }

        #save-btn {
            width: 100%;
            padding: 10px;
            background-color: #ff9933;
            border: none;
            color: white;
            font-weight: bold;
            border-radius: 5px;
            cursor: pointer;
        }

        #save-btn:hover {
            background-color: #e68a00;
        }

        /* --- Mic Controls --- */
        #mic-container {
            position: absolute;
            bottom: 40px;
            z-index: 10;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }

        #mic-btn {
            background-color: rgba(255, 69, 0, 0.8);
            border: 2px solid white;
            color: white;
            width: 70px;
            height: 70px;
            border-radius: 50%;
            font-size: 30px;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 0 15px rgba(0,0,0,0.5);
            transition: all 0.3s ease;
        }

        #mic-btn:hover {
            transform: scale(1.1);
        }

        .listening {
            animation: pulse 1.5s infinite;
            background-color: red !important;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(255, 0, 0, 0.7); }
            70% { box-shadow: 0 0 0 20px rgba(255, 0, 0, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 0, 0, 0); }
        }

        #status-text {
            color: white;
            font-size: 16px;
            font-weight: bold;
            text-shadow: 2px 2px 4px black;
            background: rgba(0, 0, 0, 0.5);
            padding: 5px 15px;
            border-radius: 20px;
        }
    </style>
</head>
<body>

    <div id="main-container">
        <video id="silent-video" autoplay muted loop playsinline>
            <source src="silent.mp4" type="video/mp4">
        </video>
        <video id="talking-video" muted loop playsinline>
            <source src="talking.mp4" type="video/mp4">
        </video>

        <div id="settings-btn" onclick="toggleSettings()">âš™ï¸</div>

        <div id="settings-modal">
            <div class="setting-item">
                <label>API Key:</label>
                <input type="text" id="api-key-input" placeholder="Paste API Key here">
            </div>
            <div class="setting-item">
                <label>Model:</label>
                <select id="model-select">
                    <option value="gemini-1.5-flash">2.5 Flash</option>
                    <option value="gemini-1.5-pro" selected>2.5 Pro</option>
                </select>
            </div>
            <button id="save-btn" onclick="saveSettings()">Save Settings</button>
        </div>

        <div id="mic-container">
            <div id="status-text">àª®àª¾àªˆàª• àª¦àª¬àª¾àªµà«‹</div>
            <button id="mic-btn" onclick="toggleListening()">ğŸ¤</button>
        </div>
    </div>

    <script>
        // --- Variables ---
        // àª¡àª¿àª«à«‹àª²à«àªŸ àª•à«€ (àªœà«‹ àª¸à«‡àªµ àª•àª°à«‡àª²à«€ àª¨ àª¹à«‹àª¯ àª¤à«‹)
        let apiKey = localStorage.getItem("vidushi_api_key") || "àª¤àª®àª¾àª°à«€_API_KEY_àª…àª¹à«€àª‚_àª®à«‚àª•à«‹";
        let currentModel = localStorage.getItem("vidushi_model") || "gemini-1.5-pro";

        // Elements
        const silentVideo = document.getElementById('silent-video');
        const talkingVideo = document.getElementById('talking-video');
        const micBtn = document.getElementById('mic-btn');
        const statusText = document.getElementById('status-text');
        const settingsModal = document.getElementById('settings-modal');
        const apiKeyInput = document.getElementById('api-key-input');
        const modelSelect = document.getElementById('model-select');

        // Load saved settings into inputs
        apiKeyInput.value = apiKey;
        modelSelect.value = currentModel;

        // --- Settings Logic ---
        function toggleSettings() {
            if (settingsModal.style.display === "block") {
                settingsModal.style.display = "none";
            } else {
                settingsModal.style.display = "block";
            }
        }

        function saveSettings() {
            const newKey = apiKeyInput.value.trim();
            const newModel = modelSelect.value;

            if (newKey) {
                apiKey = newKey;
                currentModel = newModel;
                
                // Save to local storage so it remembers next time
                localStorage.setItem("vidushi_api_key", apiKey);
                localStorage.setItem("vidushi_model", currentModel);

                settingsModal.style.display = "none";
                alert("àª¸à«‡àªŸàª¿àª‚àª— àª¸à«‡àªµ àª¥àªˆ àª—àª¯à«àª‚! âœ…");
            } else {
                alert("API Key àª–àª¾àª²à«€ àª¨ àª°àª¾àª–à«€ àª¶àª•àª¾àª¯.");
            }
        }

        // --- Video Control ---
        function setTalkingState(isTalking) {
            if (isTalking) {
                silentVideo.style.display = 'none';
                talkingVideo.style.display = 'block';
                talkingVideo.play().catch(e => console.log("Play Error:", e));
            } else {
                silentVideo.style.display = 'block';
                talkingVideo.style.display = 'none';
                talkingVideo.pause();
                talkingVideo.currentTime = 0;
            }
        }

        // --- Speech Recognition ---
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        let recognition;
        
        if (SpeechRecognition) {
            recognition = new SpeechRecognition();
            recognition.lang = 'gu-IN';
            recognition.continuous = false;

            recognition.onstart = () => {
                micBtn.classList.add('listening');
                statusText.innerText = "àª¸àª¾àª‚àª­àª³à«àª‚ àª›à«àª‚...";
            };

            recognition.onend = () => {
                micBtn.classList.remove('listening');
            };

            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript;
                statusText.innerText = "àªµàª¿àªšàª¾àª°à«àª‚ àª›à«àª‚...";
                sendMessage(transcript);
            };
        }

        function toggleListening() {
            if (window.speechSynthesis.speaking) {
                window.speechSynthesis.cancel();
                setTalkingState(false);
                statusText.innerText = "àª®àª¾àªˆàª• àª¦àª¬àª¾àªµà«‹";
                return;
            }
            if (recognition) recognition.start();
            else alert("Mic not supported in this browser.");
        }

        // --- TTS ---
        function speakText(text) {
            const cleanText = text.replace(/[.,\/#!$%\^&\*;:{}=\-_`~()?"']/g, " ");
            if ('speechSynthesis' in window) {
                window.speechSynthesis.cancel();
                const utterance = new SpeechSynthesisUtterance(cleanText);
                utterance.lang = 'gu-IN';
                
                utterance.onstart = () => {
                    statusText.innerText = "àª¬à«‹àª²à«€ àª°àª¹à«€ àª›à«àª‚...";
                    setTalkingState(true);
                };
                utterance.onend = () => {
                    setTalkingState(false);
                    statusText.innerText = "àª®àª¾àªˆàª• àª¦àª¬àª¾àªµà«‹";
                };
                utterance.onerror = () => setTalkingState(false);
                
                window.speechSynthesis.speak(utterance);
            }
        }

        // --- API Call ---
        async function sendMessage(userText) {
            // àª¬à«‹àªŸàª¨à«àª‚ àªµà«àª¯àª•à«àª¤àª¿àª¤à«àªµ (Persona)
            let history = [
                {
                    role: "user",
                    parts: [{ text: "àª¤àª¾àª°à«àª‚ àª¨àª¾àª® àªµàª¿àª¦à«àª·à«€ àª›à«‡. àªœàª¯ àª¶à«àª°à«€ àª•à«ƒàª·à«àª£ àª¥à«€ àª¶àª°à«‚àª†àª¤ àª•àª°àªœà«‡. àª¸àª¨àª¾àª¤àª¨ àª§àª°à«àª® àªµàª¿àª¶à«‡ àªŸà«‚àª‚àª•àª®àª¾àª‚ àª—à«àªœàª°àª¾àª¤à«€àª®àª¾àª‚ àªµàª¾àª¤ àª•àª°àªœà«‡. àª•à«‹àªˆ àªšàª¿àª¨à«àª¹à«‹ àª¨ àªµàª¾àªªàª°àª¤à«€." }]
                },
                {
                    role: "user",
                    parts: [{ text: userText }]
                }
            ];

            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${currentModel}:generateContent?key=${apiKey}`;

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: history })
                });

                if (!response.ok) throw new Error("API Error");

                const data = await response.json();
                if (data.candidates && data.candidates[0].content) {
                    const botResponse = data.candidates[0].content.parts[0].text;
                    speakText(botResponse);
                } else {
                    statusText.innerText = "àªœàªµàª¾àª¬ àª¨àª¾ àª®àª³à«àª¯à«‹.";
                }
            } catch (error) {
                console.error(error);
                statusText.innerText = "Error: Check API Key/Net";
            }
        }
        
        // Init
        setTalkingState(false);
    </script>
</body>
</html>
