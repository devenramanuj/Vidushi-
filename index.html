<!DOCTYPE html>
<html lang="gu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>વિદુષી - Sanatan AI</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --bg-color: #121212;
            --card-color: #1e1e1e;
            --text-color: #ffffff;
            --accent-color: #ff5722; /* ભગવો */
        }

        body {
            margin: 0; padding: 0;
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: 'Segoe UI', Tahoma, sans-serif;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* હેડર */
        header {
            padding: 15px;
            text-align: center;
            background: var(--card-color);
            border-bottom: 2px solid var(--accent-color);
            box-shadow: 0 2px 10px rgba(0,0,0,0.5);
            flex-shrink: 0;
            position: relative;
        }
        h1 { margin: 0; font-weight: 500; letter-spacing: 1px; }

        #settings-btn {
            position: absolute; right: 15px; top: 15px;
            background: none; border: none; color: white; font-size: 20px; cursor: pointer;
        }

        /* ફોટો એરિયા */
        #main-area {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 20px;
            position: relative;
        }

        /* ભારતીય સ્ત્રીનો ફોટો */
        #avatar-img {
            width: 300px;
            height: 300px;
            object-fit: cover; /* ફોટો ગોળમાં બરાબર ફિટ થશે */
            border-radius: 50%; /* ગોળ ફોટો */
            border: 4px solid var(--accent-color);
            box-shadow: 0 0 20px rgba(255, 87, 34, 0.3);
            /* હલવાનું એનિમેશન બંધ છે */
        }

        /* સ્ટેટસ ટેક્સ્ટ */
        #status-text {
            margin-top: 20px;
            font-size: 16px;
            color: #aaa;
            background: rgba(0,0,0,0.5);
            padding: 5px 15px;
            border-radius: 15px;
        }

        /* કંટ્રોલ બટનો */
        #controls {
            padding: 20px;
            background: var(--card-color);
            display: flex;
            justify-content: center;
            gap: 20px;
            border-top: 1px solid #333;
            flex-shrink: 0;
        }

        .btn {
            width: 60px; height: 60px;
            border-radius: 50%;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: white;
            transition: 0.2s;
            display: flex; align-items: center; justify-content: center;
        }

        #mic-btn { background: var(--accent-color); }
        #mic-btn:active { transform: scale(0.95); }
        #mic-btn.listening { background: red; animation: pulse 1.5s infinite; }
        
        #stop-btn { background: #444; }

        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(255,0,0,0.5); } 100% { box-shadow: 0 0 0 15px rgba(255,0,0,0); } }

        /* સેટિંગ્સ પેનલ */
        #settings-panel {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 100;
        }
        .settings-box {
            background: var(--card-color);
            padding: 20px;
            border-radius: 10px;
            width: 90%; max-width: 350px;
            border: 1px solid #444;
        }
        .settings-box input {
            width: 100%; padding: 10px; margin: 10px 0;
            background: #333; border: none; color: white; border-radius: 5px;
        }
        .settings-box button {
            width: 100%; padding: 10px; background: var(--accent-color);
            border: none; color: white; border-radius: 5px; cursor: pointer;
        }

        /* Hidden elements */
        .chat-log { display: none; }
    </style>
</head>
<body>

    <header>
        <h1>વિદુષી</h1>
        <button id="settings-btn" onclick="openSettings()"><i class="fas fa-cog"></i></button>
    </header>

    <div id="main-area">
        <img id="avatar-img" src="https://upload.wikimedia.org/wikipedia/commons/thumb/8/8c/Indian_woman_in_sari.jpg/480px-Indian_woman_in_sari.jpg" alt="Vidushi Avatar">
        
        <div id="status-text">Key સેટ કરો અને માઈક દબાવો</div>
    </div>

    <div id="controls">
        <button id="mic-btn" class="btn" onclick="toggleMic()"><i class="fas fa-microphone"></i></button>
        <button id="stop-btn" class="btn" onclick="stopAll()"><i class="fas fa-stop"></i></button>
    </div>

    <div id="settings-panel">
        <div class="settings-box">
            <h3>સેટિંગ્સ</h3>
            <label>API Key:</label>
            <input type="password" id="api-key" placeholder="Enter Gemini Key here">
            <button onclick="saveSettings()">Save & Close</button>
            <button onclick="closeSettings()" style="background:#444; margin-top:5px;">Cancel</button>
        </div>
    </div>

    <div class="chat-log" id="chat-log"></div>

    <script>
        // --- 1. Variables & Setup ---
        const micBtn = document.getElementById('mic-btn');
        const statusText = document.getElementById('status-text');
        let recognition;
        let isListening = false;

        // લોકલ સ્ટોરેજમાંથી કી લાવો
        const storedKey = localStorage.getItem('vidushi_api_key');
        if(storedKey) document.getElementById('api-key').value = storedKey;

        // --- 2. Speech Recognition ---
        if ('webkitSpeechRecognition' in window) {
            recognition = new webkitSpeechRecognition();
            recognition.lang = 'gu-IN'; // ગુજરાતી
            recognition.continuous = false;
            recognition.interimResults = false;

            recognition.onstart = () => {
                isListening = true;
                micBtn.classList.add('listening');
                statusText.innerText = "સાંભળું છું...";
            };

            recognition.onend = () => {
                isListening = false;
                micBtn.classList.remove('listening');
                statusText.innerText = "વિચારું છું...";
            };

            recognition.onresult = async (event) => {
                const transcript = event.results[0][0].transcript;
                console.log("User said:", transcript);
                await getGeminiResponse(transcript);
            };
            
            recognition.onerror = (e) => {
                console.error(e);
                statusText.innerText = "ફરી પ્રયાસ કરો";
                micBtn.classList.remove('listening');
                isListening = false;
            };
        } else {
            alert("તમારા બ્રાઉઝરમાં સ્પીચ ફીચર નથી.");
        }

        // --- 3. Gemini API ---
        async function getGeminiResponse(userText) {
            const apiKey = localStorage.getItem('vidushi_api_key');
            if (!apiKey) {
                alert("Please set API Key in settings!");
                openSettings();
                return;
            }

            // હિસ્ટ્રી અને પર્સનાલિટી
            const prompt = {
                contents: [
                    {
                        role: "user",
                        parts: [{ text: "તારું નામ વિદુષી છે. તું સનાતન ધર્મની જ્ઞાની છે. તારે ગુજરાતીમાં ટૂંકા અને સચોટ જવાબ આપવાના છે. તું એક ભારતીય સ્ત્રી છે." }]
                    },
                    {
                        role: "model",
                        parts: [{ text: "જય શ્રી કૃષ્ણ! હું વિદુષી છું." }]
                    },
                    {
                        role: "user",
                        parts: [{ text: userText }]
                    }
                ]
            };

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(prompt)
                });

                const data = await response.json();
                if(data.error) {
                    statusText.innerText = "Error: Key Check કરો";
                } else {
                    const botReply = data.candidates[0].content.parts[0].text;
                    speak(botReply);
                }
            } catch (error) {
                console.error(error);
                statusText.innerText = "ઇન્ટરનેટ એરર";
            }
        }

        // --- 4. TTS (બોલવું) ---
        function speak(text) {
            // બોલતી વખતે ફોટો સ્થિર જ રહેશે (No Animation)
            window.speechSynthesis.cancel();
            
            // સ્વચ્છ લખાણ
            const cleanText = text.replace(/[*#]/g, '');
            
            const utterance = new SpeechSynthesisUtterance(cleanText);
            utterance.lang = 'gu-IN';
            
            utterance.onstart = () => {
                statusText.innerText = "બોલે છે...";
            };
            
            utterance.onend = () => {
                statusText.innerText = "શાંત";
            };

            window.speechSynthesis.speak(utterance);
        }

        // --- 5. Controls ---
        function toggleMic() {
            if (isListening) {
                recognition.stop();
            } else {
                const key = localStorage.getItem('vidushi_api_key');
                if(!key) { openSettings(); return; }
                recognition.start();
            }
        }

        function stopAll() {
            window.speechSynthesis.cancel();
            if(recognition) recognition.stop();
            statusText.innerText = "બંધ";
        }

        // --- Settings Logic ---
        function openSettings() { document.getElementById('settings-panel').style.display = 'flex'; }
        function closeSettings() { document.getElementById('settings-panel').style.display = 'none'; }
        function saveSettings() {
            const key = document.getElementById('api-key').value;
            localStorage.setItem('vidushi_api_key', key);
            closeSettings();
            alert("Key Saved!");
        }

    </script>
</body>
</html>
