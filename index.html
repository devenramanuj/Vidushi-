<!DOCTYPE html>
<html lang="gu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>àªµàª¿àª¦à«àª·à«€ AI Assistant</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-bg: #0f0f0f;
            --secondary-bg: #1a1a1a;
            --chat-bg: #2d2d2d;
            --text-color: #e0e0e0;
            --accent-color: #8b0000; /* Dark Red */
            --glow-color: #ff4d4d;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
        
        body {
            background: var(--primary-bg);
            height: 100vh;
            color: var(--text-color);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* --- HEADER --- */
        header {
            padding: 15px;
            text-align: center;
            background: var(--secondary-bg);
            border-bottom: 2px solid var(--accent-color);
            box-shadow: 0 2px 10px rgba(0,0,0,0.5);
            z-index: 10;
        }
        
        h1 { font-size: 1.5rem; font-weight: 600; letter-spacing: 1px; }

        /* --- MAIN AVATAR AREA (REALISTIC LOOK) --- */
        .avatar-container {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
            background: radial-gradient(circle at center, #2a2a2a 0%, #0f0f0f 70%);
        }

        .vidushi-image-wrapper {
            position: relative;
            width: 220px; /* Slightly larger */
            height: 220px;
            border-radius: 50%;
            padding: 5px;
            background: linear-gradient(45deg, #444, #000);
            box-shadow: 0 0 20px rgba(0,0,0,0.8);
            transition: all 0.3s ease;
        }

        .vidushi-image {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid #333;
            /* NEW: Realistic Indian Woman Image */
            background-image: url('https://images.unsplash.com/photo-1567532939604-b6b5b0db2604?q=80&w=800&auto=format&fit=crop'); 
            background-size: cover;
            background-position: center 20%; /* Adjusted to focus on face */
        }

        /* SPEAKING ANIMATION - Breathing & Glowing */
        .vidushi-image-wrapper.speaking {
            animation: breathe 2s infinite ease-in-out;
            box-shadow: 0 0 30px var(--glow-color);
            border: 2px solid var(--glow-color);
        }

        @keyframes breathe {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        /* --- CHAT OVERLAY --- */
        .chat-overlay {
            position: absolute;
            bottom: 160px; /* Space for controls */
            width: 90%;
            max-height: 25%; /* Smaller chat area to focus on image */
            overflow-y: auto;
            background: rgba(0, 0, 0, 0.7);
            border-radius: 15px;
            padding: 15px;
            backdrop-filter: blur(5px);
            border: 1px solid #444;
            text-align: center; /* Center text for cleaner look */
        }

        .message { margin-bottom: 8px; font-size: 15px; line-height: 1.5; text-shadow: 1px 1px 2px black; }
        .message.ai { color: #fff; font-weight: 500; }
        .message.user { color: #aaa; font-size: 13px; margin-top: 5px; font-style: italic; }

        /* --- CONTROLS AREA --- */
        .controls-area {
            height: 150px;
            background: var(--secondary-bg);
            border-top: 1px solid #333;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 15px;
            padding: 10px;
            z-index: 10;
        }

        .status-text { font-size: 12px; color: #888; margin-bottom: 5px; }

        .btn-group { display: flex; gap: 20px; align-items: center; }

        .mic-btn {
            width: 70px; height: 70px;
            border-radius: 50%;
            border: none;
            background: #333;
            color: white;
            font-size: 28px;
            cursor: pointer;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
            transition: 0.2s;
        }

        .mic-btn:active { transform: scale(0.95); }
        
        .mic-btn.listening {
            background: var(--accent-color);
            animation: pulse-ring 1.5s infinite;
        }

        .stop-btn {
            width: 50px; height: 50px;
            border-radius: 50%;
            background: #222;
            color: #ff4444;
            border: 1px solid #ff4444;
            font-size: 20px;
            cursor: pointer;
        }

        .settings-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            background: transparent;
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
            z-index: 20;
        }

        @keyframes pulse-ring {
            0% { box-shadow: 0 0 0 0 rgba(139, 0, 0, 0.7); }
            70% { box-shadow: 0 0 0 15px rgba(139, 0, 0, 0); }
            100% { box-shadow: 0 0 0 0 rgba(139, 0, 0, 0); }
        }

        /* Settings Page (Hidden by default) */
        #settingsPage {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: var(--secondary-bg);
            z-index: 100;
            padding: 20px;
            overflow-y: auto;
        }
        
        .setting-item { margin-bottom: 15px; }
        .setting-item label { display: block; margin-bottom: 5px; color: #aaa; }
        .setting-item select, .setting-item input { 
            width: 100%; padding: 10px; background: #333; border: 1px solid #555; color: white; border-radius: 5px;
        }
        .close-settings {
            background: var(--accent-color); color: white; border: none; padding: 10px 20px;
            border-radius: 5px; margin-bottom: 20px; cursor: pointer;
        }
        
        .footer {
            position: fixed; bottom: 5px; width: 100%; text-align: center;
            font-size: 10px; color: #555; pointer-events: none;
        }
    </style>
</head>
<body>

    <header>
        <h1>àªµàª¿àª¦à«àª·à«€</h1>
        <button class="settings-btn" id="openSettings"><i class="fas fa-cog"></i></button>
    </header>

    <!-- Main Visual Area -->
    <div class="avatar-container">
        <!-- Image Container -->
        <div class="vidushi-image-wrapper" id="avatarWrapper">
            <div class="vidushi-image"></div>
        </div>

        <!-- Chat appears over the background -->
        <div class="chat-overlay" id="chatOverlay">
            <div class="message ai">àªœàª¯ àª¶à«àª°à«€ àª•à«ƒàª·à«àª£ ğŸ™! àª¹à«àª‚ àªµàª¿àª¦à«àª·à«€ àª›à«àª‚.</div>
        </div>
    </div>

    <!-- Controls -->
    <div class="controls-area">
        <div class="status-text" id="statusText">àª¤à«ˆàª¯àª¾àª° àª›à«‡</div>
        <div class="btn-group">
            <button class="mic-btn" id="micBtn"><i class="fas fa-microphone"></i></button>
            <button class="stop-btn" id="stopBtn"><i class="fas fa-volume-xmark"></i></button>
        </div>
    </div>

    <!-- Footer -->
    <div class="footer">Developed by - Devendra Ramanuj | 9276595936</div>

    <!-- Settings Page -->
    <div id="settingsPage">
        <button class="close-settings" id="closeSettings">â† àªªàª¾àª›àª¾ àªœàª¾àª“</button>
        <h2>àª¸à«‡àªŸàª¿àª‚àª—à«àª¸</h2>
        <div class="setting-item" style="border: 1px dashed #555; padding: 10px; margin-top: 10px;">
            <label>API Key (àª¸à«àª°àª•à«àª·àª¾ àª®àª¾àªŸà«‡ àª°àª¿àª¸à«‡àªŸ àª•àª°à«‹)</label>
            <button onclick="resetApiKey()" style="background: #444; color: white; padding: 5px; width: 100%;">Key àª¬àª¦àª²à«‹</button>
        </div>
        <div class="setting-item">
            <label>àª…àªµàª¾àªœàª¨à«€ àª—àª¤àª¿</label>
            <input type="range" id="speechRate" min="0.5" max="1.5" step="0.1" value="1.0">
        </div>
        <div class="setting-item">
            <label>àª¸àª¤àª¤ àªµàª¾àª¤àªšà«€àª¤ (Continuous)</label>
            <input type="checkbox" id="continuousMode" checked> àªšàª¾àª²à« àª°àª¾àª–à«‹
        </div>
        <div class="setting-item">
            <label>Screen Wake Lock</label>
            <input type="checkbox" id="wakeLockToggle" checked> àª¸à«àª•à«àª°à«€àª¨ àªšàª¾àª²à« àª°àª¾àª–à«‹
        </div>
    </div>

    <script>
        // --- API KEY ---
        // àª¤àª®àª¾àª°à«€ àª•à«€ àª…àª¹à«€àª‚ àªªà«‡àª¸à«àªŸ àª•àª°à«‹
        const SYSTEM_API_KEY = "àª¤àª®àª¾àª°à«€_KEY_àª…àª¹à«€àª‚_àªªà«‡àª¸à«àªŸ_àª•àª°à«‹"; 
        // ---------------

        class VidushiApp {
            constructor() {
                this.apiKey = this.getApiKey();
                this.recognition = null;
                this.synth = window.speechSynthesis;
                this.isListening = false;
                this.wakeLock = null;
                this.voices = [];
                
                this.ui = {
                    micBtn: document.getElementById('micBtn'),
                    stopBtn: document.getElementById('stopBtn'),
                    status: document.getElementById('statusText'),
                    avatar: document.getElementById('avatarWrapper'),
                    chat: document.getElementById('chatOverlay'),
                    settingsPage: document.getElementById('settingsPage'),
                    rateInput: document.getElementById('speechRate')
                };

                this.init();
            }

            getApiKey() {
                if (SYSTEM_API_KEY && !SYSTEM_API_KEY.includes("àªªà«‡àª¸à«àªŸ_àª•àª°à«‹")) return SYSTEM_API_KEY;
                return localStorage.getItem('geminiApiKey') || "";
            }

            init() {
                // Event Listeners
                this.ui.micBtn.onclick = () => this.toggleListen();
                this.ui.stopBtn.onclick = () => this.stopAll();
                document.getElementById('openSettings').onclick = () => this.ui.settingsPage.style.display = 'block';
                document.getElementById('closeSettings').onclick = () => this.ui.settingsPage.style.display = 'none';
                
                // Initialize Speech Safely
                if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                    this.recognition = new SpeechRecognition();
                    this.recognition.lang = 'gu-IN';
                    this.recognition.continuous = false;
                    this.recognition.onstart = () => this.onListenStart();
                    this.recognition.onend = () => this.onListenEnd();
                    this.recognition.onresult = (e) => this.onListenResult(e);
                    this.recognition.onerror = (e) => this.onListenError(e);
                } else {
                    alert("àª¤àª®àª¾àª°à«‹ àª«à«‹àª¨ àª¸à«àªªà«€àªš àª¸àªªà«‹àª°à«àªŸ àª¨àª¥à«€ àª•àª°àª¤à«‹.");
                }

                // Check Key
                if (!this.apiKey) setTimeout(() => this.promptKey(), 1000);

                // Load Voices
                setTimeout(() => { this.voices = this.synth.getVoices(); }, 500);
                if (this.synth.onvoiceschanged !== undefined) this.synth.onvoiceschanged = () => { this.voices = this.synth.getVoices(); };
            }

            promptKey() {
                const key = prompt("Gemini API Key àª¨àª¾àª–à«‹:");
                if (key) {
                    this.apiKey = key;
                    localStorage.setItem('geminiApiKey', key);
                }
            }

            // --- CORE LOGIC ---

            toggleListen() {
                if (this.isListening) this.stopAll();
                else {
                    if(!this.apiKey) { this.promptKey(); return; }
                    this.recognition.start();
                }
            }

            onListenStart() {
                this.isListening = true;
                this.ui.micBtn.classList.add('listening');
                this.ui.status.innerText = "àª¸àª¾àª‚àª­àª³à«àª‚ àª›à«àª‚...";
                this.activateWakeLock();
                // Clear old user message but keep AI message visible until new one comes
            }

            onListenEnd() {
                this.isListening = false;
                this.ui.micBtn.classList.remove('listening');
            }

            onListenResult(event) {
                const text = event.results[0][0].transcript;
                // Show user message
                this.ui.chat.innerHTML = `<div class="message user">${text}</div>`;
                this.processAI(text);
            }

            onListenError(e) {
                console.error(e);
                if(e.error === 'not-allowed') {
                    this.ui.status.innerText = "Error: Mic Permission Denied";
                    alert("àª®àª¾àªˆàª•à«àª°à«‹àª«à«‹àª¨ àªªàª°àª®àª¿àª¶àª¨ àª¨àª¥à«€. àªàªª àª¸à«‡àªŸàª¿àª‚àª—à«àª¸àª®àª¾àª‚ àªœàªˆàª¨à«‡ àª®àª‚àªœà«‚àª°à«€ àª†àªªà«‹.");
                } else {
                    this.ui.status.innerText = "àª«àª°à«€ àªªà«àª°àª¯àª¤à«àª¨ àª•àª°à«‹";
                }
                this.isListening = false;
                this.ui.micBtn.classList.remove('listening');
            }

            async processAI(text) {
                this.ui.status.innerText = "àªµàª¿àªšàª¾àª°à«àª‚ àª›à«àª‚...";
                this.ui.avatar.classList.add('speaking'); // Gentle pulse while thinking

                try {
                    const response = await this.fetchGemini(text);
                    // Update Chat with AI response
                    this.ui.chat.innerHTML = `<div class="message ai">${response}</div>`;
                    this.speak(response);
                } catch (err) {
                    this.ui.status.innerText = "Error: " + err.message;
                    this.ui.avatar.classList.remove('speaking');
                }
            }

            async fetchGemini(prompt) {
                const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${this.apiKey}`;
                
                const now = new Date().toLocaleString('gu-IN');
                const systemPrompt = `àª¤àª¾àª°à«àª‚ àª¨àª¾àª® àªµàª¿àª¦à«àª·à«€ àª›à«‡. àª¤àª¾àª°à«àª‚ àª¸àª°à«àªœàª¨ àª¦à«‡àªµà«‡àª¨à«àª¦à«àª° àª°àª¾àª®àª¾àª¨à«àªœ àª¦à«àªµàª¾àª°àª¾ àª¥àª¯à«àª‚ àª›à«‡. àª¤à«àª‚ àªàª• àª­àª¾àª°àª¤à«€àª¯ àª¸à«àª¤à«àª°à«€àª¨à«€ àªœà«‡àª® àª¸àª‚àª¸à«àª•àª¾àª°à«€ àª…àª¨à«‡ àªœà«àªàª¾àª¨à«€ àª›à«‡. àª¤àª¾àª°à«‡ 'àªœàª¯ àª¶à«àª°à«€ àª•à«ƒàª·à«àª£' àª¥à«€ àªµàª¾àª¤ àª•àª°àªµà«€. àª…àª¤à«àª¯àª¾àª°àª¨à«‹ àª¸àª®àª¯: ${now}.`;

                const res = await fetch(url, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        contents: [{ role: 'user', parts: [{ text: prompt }] }],
                        systemInstruction: { parts: [{ text: systemPrompt }] }
                    })
                });
                
                const data = await res.json();
                if(data.error) throw new Error(data.error.message);
                return data.candidates[0].content.parts[0].text;
            }

            speak(text) {
                this.synth.cancel();
                
                // Clean Text
                const cleanText = text.replace(/[*#_`~>\[\]()]/g, "").replace(/https?:\/\/\S+/g, " àª²àª¿àª‚àª• ");
                
                const utterance = new SpeechSynthesisUtterance(cleanText);
                utterance.lang = 'gu-IN';
                utterance.rate = parseFloat(this.ui.rateInput.value);

                // Animation ON
                this.ui.status.innerText = "àª¬à«‹àª²à«‡ àª›à«‡...";
                this.ui.avatar.classList.add('speaking');

                utterance.onend = () => {
                    this.ui.avatar.classList.remove('speaking'); // Animation OFF
                    this.ui.status.innerText = "àª¤à«ˆàª¯àª¾àª° àª›à«‡";
                    
                    // Continuous Mode Check
                    if (document.getElementById('continuousMode').checked) {
                        setTimeout(() => this.recognition.start(), 500);
                    }
                };

                this.synth.speak(utterance);
            }

            stopAll() {
                this.recognition.stop();
                this.synth.cancel();
                this.isListening = false;
                this.ui.avatar.classList.remove('speaking');
                this.ui.status.innerText = "àª¬àª‚àª§ àª•àª°à«àª¯à«àª‚";
            }
            
            async activateWakeLock() {
                if (!document.getElementById('wakeLockToggle').checked) return;
                try { if ('wakeLock' in navigator) this.wakeLock = await navigator.wakeLock.request('screen'); } catch(e){}
            }
        }

        function resetApiKey() {
            localStorage.removeItem('geminiApiKey');
            alert("àª•à«€ àª°àª¿àª¸à«‡àªŸ àª¥àªˆ. àªªà«‡àªœ àª°àª¿àª«à«àª°à«‡àª¶ àª•àª°à«‹.");
            location.reload();
        }

        // Start App
        new VidushiApp();
    </script>
</body>
</html>


