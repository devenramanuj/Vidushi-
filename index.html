<!DOCTYPE html>
<html lang="gu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>વિદુષી Real Avatar</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --bg-color: #000000;
            --text-color: #e0e0e0;
            --accent-color: #ff0055;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
        
        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-between;
            overflow: hidden;
        }

        /* --- HEADER --- */
        .header {
            position: absolute;
            top: 0;
            width: 100%;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 10;
            background: linear-gradient(to bottom, rgba(0,0,0,0.8), transparent);
        }
        
        .header h1 { font-size: 1.2rem; color: rgba(255,255,255,0.8); }
        .settings-btn { background: none; border: none; color: white; font-size: 1.5rem; cursor: pointer; }

        /* --- VIDEO AVATAR --- */
        .avatar-container {
            position: absolute;
            top: 0; left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        video {
            width: 100%;
            height: 100%;
            object-fit: cover; /* આખા સ્ક્રીન પર ફેલાવવા માટે */
            opacity: 0.8;
            transition: transform 0.3s;
        }

        /* બોલતી વખતે થોડું Zoom થાય */
        video.speaking {
            transform: scale(1.05);
            filter: brightness(1.1);
        }

        /* સાંભળતી વખતે થોડું ઝાંખું થાય */
        video.listening {
            opacity: 0.6;
            filter: grayscale(0.3);
        }

        /* --- CHAT OVERLAY --- */
        .chat-overlay {
            position: absolute;
            bottom: 120px; /* Controls ની ઉપર */
            width: 90%;
            max-height: 200px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 5;
            mask-image: linear-gradient(to top, black 80%, transparent 100%);
        }

        .chat-bubble {
            background: rgba(0, 0, 0, 0.6);
            padding: 10px 15px;
            border-radius: 20px;
            font-size: 1rem;
            backdrop-filter: blur(5px);
            max-width: 100%;
            align-self: flex-start;
            border-left: 3px solid var(--accent-color);
            animation: fadeIn 0.5s ease;
            text-shadow: 1px 1px 2px black;
        }
        
        .chat-bubble.user { align-self: flex-end; border-left: none; border-right: 3px solid #00ffff; text-align: right; }

        /* --- CONTROLS --- */
        .controls {
            width: 100%;
            padding: 30px;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 30px;
            z-index: 10;
            background: linear-gradient(to top, rgba(0,0,0,0.9) 20%, transparent);
        }

        .control-btn {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255,255,255,0.1);
            color: #fff;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
        }

        #micBtn {
            width: 75px;
            height: 75px;
            font-size: 2rem;
            background: rgba(255, 0, 85, 0.8);
            box-shadow: 0 0 20px rgba(255, 0, 85, 0.4);
        }
        
        #micBtn.active { background: #fff; color: #ff0055; animation: pulse 1.5s infinite; }

        /* --- SETTINGS PANEL --- */
        #settingsPanel {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: #111;
            z-index: 20;
            padding: 20px;
            display: none;
            flex-direction: column;
        }
        
        .setting-item { margin-bottom: 20px; }
        .setting-item label { display: block; color: #888; margin-bottom: 5px; }
        .setting-item input, .setting-item select {
            width: 100%; padding: 12px; background: #222; border: 1px solid #333;
            color: white; border-radius: 8px;
        }

        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(255, 255, 255, 0.4); } 70% { box-shadow: 0 0 0 20px rgba(255, 255, 255, 0); } }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    </style>
</head>
<body>

    <div id="settingsPanel">
        <button onclick="toggleSettings()" style="background:none; border:none; color:white; font-size:1.2rem; margin-bottom:20px;"><i class="fas fa-arrow-left"></i> Back</button>
        <h2 style="color:white; margin-bottom:20px;">Settings</h2>
        
        <div class="setting-item">
            <label>API Key</label>
            <input type="password" id="apiKey" placeholder="Paste Gemini API Key">
        </div>

        <div class="setting-item">
            <label>Model</label>
            <select id="modelSelect">
                <option value="gemini-2.5-flash">Gemini 2.5 Flash</option>
                <option value="gemini-2.5-pro">Gemini 2.5 Pro</option>
                <option value="gemini-1.5-flash">Gemini 1.5 Flash</option>
            </select>
        </div>

        <button onclick="saveSettings()" style="width:100%; padding:15px; background:#ff0055; border:none; border-radius:8px; color:white; font-weight:bold;">Save</button>
    </div>

    <div class="avatar-container">
        <video id="vidushiVideo" loop muted playsinline poster="https://via.placeholder.com/400x600/000000/ffffff?text=Vidushi">
            <source src="vidushi.mp4" type="video/mp4">
            તમારું બ્રાઉઝર વિડીયો સપોર્ટ કરતું નથી.
        </video>
    </div>

    <div class="header">
        <h1>Vidushi Avatar</h1>
        <button class="settings-btn" onclick="toggleSettings()"><i class="fas fa-cog"></i></button>
    </div>

    <div class="chat-overlay" id="chatOverlay"></div>

    <div class="controls">
        <button class="control-btn" onclick="clearContext()"><i class="fas fa-eraser"></i></button>
        <button class="control-btn" id="micBtn" onclick="toggleMic()"><i class="fas fa-microphone"></i></button>
        <button class="control-btn" onclick="stopSpeaking()"><i class="fas fa-stop"></i></button>
    </div>

    <script>
        const SYSTEM_PROMPT = `You are Vidushi, a friendly Indian woman AI assistant. Speak naturally in Gujarati. Be concise, warm, and helpful.`;

        let state = {
            isListening: false,
            isSpeaking: false,
            apiKey: localStorage.getItem('vidushi_key') || '',
            model: localStorage.getItem('vidushi_model') || 'gemini-2.5-flash',
        };

        const vid = document.getElementById('vidushiVideo');
        const micBtn = document.getElementById('micBtn');
        const chatOverlay = document.getElementById('chatOverlay');

        // Speech Setup
        const recognition = new (window.webkitSpeechRecognition || window.SpeechRecognition)();
        recognition.lang = 'gu-IN';
        recognition.continuous = false;

        const synth = window.speechSynthesis;
        let voices = [];

        window.onload = () => {
            document.getElementById('apiKey').value = state.apiKey;
            document.getElementById('modelSelect').value = state.model;
            
            // Load voices
            const getVoices = () => { voices = synth.getVoices(); };
            if (synth.onvoiceschanged !== undefined) synth.onvoiceschanged = getVoices;
            setTimeout(getVoices, 500);
        };

        // --- VIDEO LOGIC ---
        function setAvatarState(status) {
            vid.className = status; // speaking, listening, idle
            if (status === 'speaking') {
                vid.play(); // વિડીયો ચાલુ કરો (મોઢું હલે તેવો વિડીયો હોય તો બેસ્ટ)
            } else {
                vid.pause(); // વિડીયો અટકાવો
            }
        }

        // --- CORE FUNCTIONS ---
        function toggleMic() {
            if (!state.apiKey) { toggleSettings(); return; }

            if (state.isListening) {
                recognition.stop();
            } else {
                if (state.isSpeaking) stopSpeaking();
                try {
                    recognition.start();
                    state.isListening = true;
                    micBtn.classList.add('active');
                    setAvatarState('listening');
                } catch (e) { console.log(e); }
            }
        }

        recognition.onend = () => {
            state.isListening = false;
            micBtn.classList.remove('active');
            if (!state.isSpeaking) setAvatarState('idle');
        };

        recognition.onresult = async (event) => {
            const transcript = event.results[0][0].transcript;
            addChatBubble(transcript, 'user');
            await processGemini(transcript);
        };

        async function processGemini(text) {
            try {
                const url = `https://generativelanguage.googleapis.com/v1beta/models/${state.model}:generateContent?key=${state.apiKey}`;
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        systemInstruction: { parts: [{ text: SYSTEM_PROMPT }] },
                        contents: [{ parts: [{ text: text }] }]
                    })
                });
                const data = await response.json();
                const reply = data.candidates[0].content.parts[0].text;
                addChatBubble(reply, 'ai');
                speak(reply);
            } catch (error) {
                addChatBubble("Error connecting.", 'ai');
            }
        }

        function speak(text) {
            if (synth.speaking) synth.cancel();
            const cleanText = text.replace(/[*#]/g, '');
            const utterance = new SpeechSynthesisUtterance(cleanText);
            utterance.lang = 'gu-IN';
            utterance.rate = 1.1;

            const gujVoice = voices.find(v => v.lang.includes('gu'));
            if (gujVoice) utterance.voice = gujVoice;

            utterance.onstart = () => {
                state.isSpeaking = true;
                setAvatarState('speaking'); // વિડીયો ચાલુ
            };

            utterance.onend = () => {
                state.isSpeaking = false;
                setAvatarState('idle'); // વિડીયો બંધ
            };

            synth.speak(utterance);
        }

        function stopSpeaking() {
            synth.cancel();
            state.isSpeaking = false;
            setAvatarState('idle');
        }

        function addChatBubble(text, type) {
            const div = document.createElement('div');
            div.className = `chat-bubble ${type}`;
            div.innerText = text;
            chatOverlay.appendChild(div);
            chatOverlay.scrollTop = chatOverlay.scrollHeight;
        }

        function toggleSettings() {
            const panel = document.getElementById('settingsPanel');
            panel.style.display = panel.style.display === 'flex' ? 'none' : 'flex';
        }

        function saveSettings() {
            state.apiKey = document.getElementById('apiKey').value;
            state.model = document.getElementById('modelSelect').value;
            localStorage.setItem('vidushi_key', state.apiKey);
            localStorage.setItem('vidushi_model', state.model);
            toggleSettings();
        }

        function clearContext() { chatOverlay.innerHTML = ''; }
    </script>
</body>
</html>
