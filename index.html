<!DOCTYPE html>
<html lang="gu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vidushi Debugger</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { background: #000; color: white; font-family: sans-serif; height: 100vh; display: flex; flex-direction: column; overflow: hidden; margin: 0;}
        
        /* Video Background */
        #videoContainer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; }
        video { width: 100%; height: 100%; object-fit: cover; opacity: 0.8; }
        
        /* UI */
        #ui { position: absolute; z-index: 10; width: 100%; height: 100%; display: flex; flex-direction: column; justify-content: flex-end; pointer-events: none; }
        
        .header { pointer-events: auto; padding: 15px; background: rgba(0,0,0,0.8); display: flex; justify-content: space-between; align-items: center; position: absolute; top: 0; width: 100%; }
        
        #chat { flex-grow: 1; overflow-y: auto; padding: 20px; margin-bottom: 100px; display: flex; flex-direction: column; gap: 10px; pointer-events: auto; }
        
        .bubble { padding: 10px 15px; border-radius: 15px; max-width: 80%; background: rgba(0,0,0,0.7); backdrop-filter: blur(5px); }
        .bubble.user { align-self: flex-end; border-right: 3px solid cyan; }
        .bubble.ai { align-self: flex-start; border-left: 3px solid #ff0055; }
        .bubble.error { border: 1px solid red; color: #ff9999; }

        .controls { pointer-events: auto; position: absolute; bottom: 0; width: 100%; padding: 20px; background: linear-gradient(to top, black, transparent); display: flex; justify-content: center; gap: 20px; }
        
        .btn { width: 60px; height: 60px; border-radius: 50%; border: none; font-size: 1.5rem; cursor: pointer; background: rgba(255,255,255,0.2); color: white; display: flex; align-items: center; justify-content: center; }
        #micBtn { background: #ff0055; box-shadow: 0 0 15px #ff0055; }
        #micBtn.listening { background: white; color: #ff0055; animation: pulse 1s infinite; }

        /* Settings */
        #settings { pointer-events: auto; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #111; z-index: 20; padding: 20px; display: none; flex-direction: column; gap: 15px; }
        input, select { width: 100%; padding: 15px; background: #222; border: 1px solid #444; color: white; border-radius: 5px; margin-top: 5px; }
        label { color: #aaa; font-size: 0.9rem; }
        
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
    </style>
</head>
<body>

    <div id="videoContainer">
        <video id="vid" loop muted playsinline>
            <source src="vidushi.mp4" type="video/mp4">
        </video>
    </div>

    <div id="ui">
        <div class="header">
            <h3>Vidushi Debug Mode</h3>
            <button onclick="openSettings()" style="background:none; border:none; color:white; font-size:1.5rem;"><i class="fas fa-cog"></i></button>
        </div>

        <div id="chat"></div>

        <div class="controls">
            <button class="btn" onclick="location.reload()"><i class="fas fa-sync"></i></button>
            <button class="btn" id="micBtn" onclick="toggleMic()"><i class="fas fa-microphone"></i></button>
        </div>
    </div>

    <div id="settings">
        <div style="display:flex; justify-content:space-between;">
            <h2>Settings</h2>
            <button onclick="closeSettings()" style="background:none; border:none; color:white; font-size:1.5rem;">X</button>
        </div>
        
        <div>
            <label>API Key (Paste carefully)</label>
            <input type="text" id="apiKey" placeholder="AIza...">
        </div>

        <div>
            <label>Model</label>
            <select id="model">
                <option value="gemini-1.5-flash">Gemini 1.5 Flash (Best)</option>
                <option value="gemini-1.5-pro">Gemini 1.5 Pro</option>
            </select>
        </div>

        <button onclick="testConnection()" style="padding:15px; background:orange; border:none; color:black; font-weight:bold; cursor:pointer; border-radius:5px;">
            <i class="fas fa-bolt"></i> Test Connection (દબાવો)
        </button>

        <button onclick="saveSettings()" style="padding:15px; background:#ff0055; border:none; color:white; font-weight:bold; cursor:pointer; border-radius:5px;">
            Save & Close
        </button>
        
        <div id="testResult" style="margin-top:10px; font-size:0.9rem; color:yellow;"></div>
    </div>

    <script>
        let config = {
            key: localStorage.getItem('v_key') || '',
            model: localStorage.getItem('v_model') || 'gemini-1.5-flash'
        };

        const vid = document.getElementById('vid');
        const chat = document.getElementById('chat');
        const micBtn = document.getElementById('micBtn');

        // Initial Setup
        document.getElementById('apiKey').value = config.key;
        document.getElementById('model').value = config.model;

        // Speech
        const recognition = new (window.webkitSpeechRecognition || window.SpeechRecognition)();
        recognition.lang = 'gu-IN';
        recognition.onresult = (e) => {
            const text = e.results[0][0].transcript;
            addMsg(text, 'user');
            askGemini(text);
        };
        recognition.onend = () => {
            micBtn.classList.remove('listening');
            vid.pause();
        };

        function toggleMic() {
            if(!config.key) { openSettings(); return; }
            micBtn.classList.add('listening');
            try { recognition.start(); } catch(e) {}
            vid.play(); // Mock listen animation
        }

        async function askGemini(text) {
            addMsg("વિચારું છું...", 'ai');
            
            try {
                const url = `https://generativelanguage.googleapis.com/v1beta/models/${config.model}:generateContent?key=${config.key}`;
                
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: text }] }]
                    })
                });

                const data = await response.json();

                // Remove loading
                chat.lastChild.remove();

                if(data.error) {
                    throw new Error(data.error.message);
                }

                const reply = data.candidates[0].content.parts[0].text;
                addMsg(reply, 'ai');
                speak(reply);

            } catch(e) {
                if(chat.lastChild.innerText === "વિચારું છું...") chat.lastChild.remove();
                addMsg("Error: " + e.message, 'error');
                // Alert the exact error to user
                alert("API Error: " + e.message);
            }
        }

        // Test Button Logic
        async function testConnection() {
            const k = document.getElementById('apiKey').value;
            const m = document.getElementById('model').value;
            const resBox = document.getElementById('testResult');
            
            resBox.innerText = "Testing...";
            resBox.style.color = "yellow";

            try {
                const url = `https://generativelanguage.googleapis.com/v1beta/models/${m}:generateContent?key=${k}`;
                const res = await fetch(url, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ contents: [{ parts: [{ text: "Hi" }] }] })
                });
                const data = await res.json();

                if(data.error) {
                    resBox.innerText = "FAIL: " + data.error.message;
                    resBox.style.color = "red";
                    alert("ભૂલ: " + data.error.message);
                } else {
                    resBox.innerText = "SUCCESS! Connection OK.";
                    resBox.style.color = "#00ff00";
                    alert("સફળ! તમારી Key બરાબર છે.");
                }
            } catch(e) {
                resBox.innerText = "Network Error: " + e.message;
                resBox.style.color = "red";
            }
        }

        function speak(text) {
            window.speechSynthesis.cancel();
            const u = new SpeechSynthesisUtterance(text.replace(/[*#]/g, ''));
            u.lang = 'gu-IN';
            u.onstart = () => vid.play();
            u.onend = () => vid.pause();
            window.speechSynthesis.speak(u);
        }

        function addMsg(text, type) {
            const d = document.createElement('div');
            d.className = 'bubble ' + type;
            d.innerText = text;
            chat.appendChild(d);
            chat.scrollTop = chat.scrollHeight;
        }

        function openSettings() { document.getElementById('settings').style.display = 'flex'; }
        function closeSettings() { document.getElementById('settings').style.display = 'none'; }
        
        function saveSettings() {
            config.key = document.getElementById('apiKey').value.trim();
            config.model = document.getElementById('model').value;
            localStorage.setItem('v_key', config.key);
            localStorage.setItem('v_model', config.model);
            closeSettings();
            addMsg("Settings saved.", 'ai');
        }
    </script>
</body>
</html>
