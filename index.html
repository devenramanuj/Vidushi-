<!DOCTYPE html>
<html lang="gu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vidushi AI</title>
    <style>
        /* --- CSS Styles --- */
        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            background-color: #000;
            font-family: 'Arial', sans-serif;
        }

        /* --- Video Layer --- */
        #video-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1; /* рк╡рк┐ркбрлАркпрлЛ рк╕рлМркерлА рккрк╛ркЫрк│ */
        }

        video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        #talking-video {
            display: none;
        }

        /* --- SETTINGS BUTTON (FIXED ON TOP) --- */
        #settings-btn {
            position: fixed; /* рк╕рлНркХрлНрк░рлАрки рккрк░ ркЪрлЛркВркЯрлЗрк▓рлБркВ рк░рк╣рлЗрк╢рлЗ */
            top: 20px;
            right: 20px;
            z-index: 1000; /* рк╕рлМркерлА ркЙрккрк░ */
            background-color: #ff4500; /* рк▓рк╛рк▓ ркХрк▓рк░ ркЬрлЗркерлА ркжрлЗркЦрк╛ркп */
            color: white;
            border: 2px solid white;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            font-size: 30px;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
        }

        #settings-btn:hover {
            transform: scale(1.1);
        }

        /* --- Settings Modal --- */
        #settings-modal {
            display: none;
            position: fixed;
            top: 80px;
            right: 20px;
            z-index: 1001;
            background: rgba(20, 20, 20, 0.95);
            padding: 20px;
            border-radius: 10px;
            width: 280px;
            border: 1px solid #ff4500;
            color: white;
            box-shadow: 0 0 20px rgba(0,0,0,0.8);
        }

        .setting-item {
            margin-bottom: 15px;
        }

        .setting-item label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #ff9933;
        }

        .setting-item input, .setting-item select {
            width: 90%;
            padding: 8px;
            border-radius: 5px;
            border: 1px solid #555;
            background: #333;
            color: white;
            font-size: 14px;
        }

        #save-btn {
            width: 100%;
            padding: 10px;
            background-color: #ff9933;
            border: none;
            color: white;
            font-weight: bold;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 10px;
        }

        /* --- Mic Controls --- */
        #mic-container {
            position: fixed;
            bottom: 40px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 500;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }

        #mic-btn {
            background-color: rgba(255, 69, 0, 0.8);
            border: 2px solid white;
            color: white;
            width: 70px;
            height: 70px;
            border-radius: 50%;
            font-size: 30px;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 0 15px rgba(0,0,0,0.5);
        }

        .listening {
            animation: pulse 1.5s infinite;
            background-color: red !important;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(255, 0, 0, 0.7); }
            70% { box-shadow: 0 0 0 20px rgba(255, 0, 0, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 0, 0, 0); }
        }

        #status-text {
            color: white;
            font-size: 16px;
            font-weight: bold;
            background: rgba(0, 0, 0, 0.6);
            padding: 5px 15px;
            border-radius: 20px;
        }
    </style>
</head>
<body>

    <div id="video-container">
        <video id="silent-video" autoplay muted loop playsinline>
            <source src="silent.mp4" type="video/mp4">
        </video>
        <video id="talking-video" muted loop playsinline>
            <source src="talking.mp4" type="video/mp4">
        </video>
    </div>

    <div id="settings-btn" onclick="toggleSettings()">тЪЩя╕П</div>

    <div id="settings-modal">
        <h3 style="margin-top:0; color: #ff9933; text-align: center;">Settings</h3>
        
        <div class="setting-item">
            <label>API Key:</label>
            <input type="text" id="api-key-input" placeholder="Enter API Key">
        </div>

        <div class="setting-item">
            <label>Model Version:</label>
            <select id="model-select">
                <option value="gemini-1.5-flash">2.5 Flash</option>
                <option value="gemini-1.5-pro" selected>2.5 Pro</option>
            </select>
        </div>

        <button id="save-btn" onclick="saveSettings()">Save & Close</button>
    </div>

    <div id="mic-container">
        <div id="status-text">ркорк╛ркИркХ ркжркмрк╛рк╡рлЛ</div>
        <button id="mic-btn" onclick="toggleListening()">ЁЯОд</button>
    </div>

    <script>
        // --- Logic ---
        
        // 1. Load Settings
        let apiKey = localStorage.getItem("vidushi_api_key") || "ркдркорк╛рк░рлА_API_KEY_ркЕрк╣рлАркВ_ркорлВркХрлЛ";
        let currentModel = localStorage.getItem("vidushi_model") || "gemini-1.5-pro";

        // Elements
        const silentVideo = document.getElementById('silent-video');
        const talkingVideo = document.getElementById('talking-video');
        const micBtn = document.getElementById('mic-btn');
        const statusText = document.getElementById('status-text');
        const settingsModal = document.getElementById('settings-modal');
        const apiKeyInput = document.getElementById('api-key-input');
        const modelSelect = document.getElementById('model-select');

        // Set inputs to current values
        apiKeyInput.value = apiKey === "ркдркорк╛рк░рлА_API_KEY_ркЕрк╣рлАркВ_ркорлВркХрлЛ" ? "" : apiKey;
        modelSelect.value = currentModel;

        // --- Settings Functions ---
        function toggleSettings() {
            if (settingsModal.style.display === "block") {
                settingsModal.style.display = "none";
            } else {
                settingsModal.style.display = "block";
            }
        }

        function saveSettings() {
            const newKey = apiKeyInput.value.trim();
            const newModel = modelSelect.value;

            if (newKey) {
                apiKey = newKey;
                currentModel = newModel;
                
                // Save to browser memory
                localStorage.setItem("vidushi_api_key", apiKey);
                localStorage.setItem("vidushi_model", currentModel);

                settingsModal.style.display = "none";
                alert("рк╕рлЗркЯрк┐ркВркЧ рк╕рлЗрк╡ ркеркИ ркЧркпрлБркВ!");
            } else {
                alert("API Key ркирк╛ркЦрк╡рлА ркЬрк░рлВрк░рлА ркЫрлЗ.");
            }
        }

        // --- Video Control ---
        function setTalkingState(isTalking) {
            if (isTalking) {
                silentVideo.style.display = 'none';
                talkingVideo.style.display = 'block';
                talkingVideo.play().catch(e => console.log(e));
            } else {
                silentVideo.style.display = 'block';
                talkingVideo.style.display = 'none';
                talkingVideo.pause();
                talkingVideo.currentTime = 0;
            }
        }

        // --- Speech Recognition ---
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        let recognition;
        
        if (SpeechRecognition) {
            recognition = new SpeechRecognition();
            recognition.lang = 'gu-IN';
            recognition.continuous = false;

            recognition.onstart = () => {
                micBtn.classList.add('listening');
                statusText.innerText = "рк╕рк╛ркВркнрк│рлБркВ ркЫрлБркВ...";
            };

            recognition.onend = () => {
                micBtn.classList.remove('listening');
            };

            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript;
                statusText.innerText = "рк╡рк┐ркЪрк╛рк░рлБркВ ркЫрлБркВ...";
                sendMessage(transcript);
            };
        }

        function toggleListening() {
            // Stop talking if active
            if (window.speechSynthesis.speaking) {
                window.speechSynthesis.cancel();
                setTalkingState(false);
                statusText.innerText = "ркорк╛ркИркХ ркжркмрк╛рк╡рлЛ";
                return;
            }
            
            // Start listening
            if (recognition) {
                recognition.start();
            } else {
                alert("Browser does not support speech recognition.");
            }
        }

        // --- TTS (Speak) ---
        function speakText(text) {
            const cleanText = text.replace(/[.,\/#!$%\^&\*;:{}=\-_`~()?"']/g, " ");
            
            if ('speechSynthesis' in window) {
                window.speechSynthesis.cancel();
                const utterance = new SpeechSynthesisUtterance(cleanText);
                utterance.lang = 'gu-IN';
                
                utterance.onstart = () => {
                    statusText.innerText = "ркмрлЛрк▓рлА рк░рк╣рлА ркЫрлБркВ...";
                    setTalkingState(true);
                };
                utterance.onend = () => {
                    setTalkingState(false);
                    statusText.innerText = "ркорк╛ркИркХ ркжркмрк╛рк╡рлЛ";
                };
                utterance.onerror = () => setTalkingState(false);
                
                window.speechSynthesis.speak(utterance);
            }
        }

        // --- Gemini API Call ---
        async function sendMessage(userText) {
            if(!apiKey || apiKey === "ркдркорк╛рк░рлА_API_KEY_ркЕрк╣рлАркВ_ркорлВркХрлЛ") {
                alert("ркХрлГрккрк╛ ркХрк░рлАркирлЗ рккрк╣рлЗрк▓рк╛ рк╕рлЗркЯрк┐ркВркЧ (тЪЩя╕П) ркорк╛ркВ ркЬркИркирлЗ API Key ркирк╛ркЦрлЛ.");
                statusText.innerText = "API Key ркЦрлВркЯрлЗ ркЫрлЗ";
                return;
            }

            const history = [
                {
                    role: "user",
                    parts: [{ text: "ркдрк╛рк░рлБркВ ркирк╛рко рк╡рк┐ркжрлБрк╖рлА ркЫрлЗ. ркЬркп рк╢рлНрк░рлА ркХрлГрк╖рлНркг ркерлА рк╡рк╛ркд рк╢рк░рлВ ркХрк░рк╡рлА. рк╕ркирк╛ркдрки ркзрк░рлНрко рк╡рк┐рк╢рлЗ ркЯрлВркВркХркорк╛ркВ ркЧрлБркЬрк░рк╛ркдрлАркорк╛ркВ рк╡рк╛ркд ркХрк░рк╡рлА. ркЬрк╡рк╛ркмркорк╛ркВ ркХрлЛркИ ркЪрк┐ркирлНрк╣рлЛ рки рк╡рк╛рккрк░рк╡рк╛." }]
                },
                {
                    role: "user",
                    parts: [{ text: userText }]
                }
            ];

            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${currentModel}:generateContent?key=${apiKey}`;

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: history })
                });

                if (!response.ok) throw new Error("API Error");

                const data = await response.json();
                if (data.candidates && data.candidates[0].content) {
                    const botResponse = data.candidates[0].content.parts[0].text;
                    speakText(botResponse);
                } else {
                    statusText.innerText = "ркХрлЛркИ ркЬрк╡рк╛ркм рки ркорк│рлНркпрлЛ.";
                }
            } catch (error) {
                console.error(error);
                statusText.innerText = "Error: API Key ркЪрлЗркХ ркХрк░рлЛ";
            }
        }
        
        // Init
        setTalkingState(false);
    </script>
</body>
</html>
